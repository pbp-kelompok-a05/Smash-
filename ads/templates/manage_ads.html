{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="max-w-7xl mx-auto px-6 py-10 space-y-10">

  <!-- ðŸ”¹ HEADER -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
        ðŸ“¢ Kelola Iklan
      </h1>
      <p class="text-gray-500 mt-1">
        Tambahkan, ubah, atau hapus iklan yang akan ditampilkan ke pengguna.
      </p>
    </div>
    <a href="#form-section" class="mt-4 md:mt-0 bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition">
      + Tambah Iklan
    </a>
  </div>

  <!-- ðŸ”¹ FORM TAMBAH IKLAN -->
  <section id="form-section" class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center gap-2">
      ðŸ§¾ Form Tambah Iklan
    </h2>

    <form id="ad-form" method="POST" enctype="multipart/form-data" class="space-y-5">
      {% csrf_token %}
      <div class="grid md:grid-cols-2 gap-6">

        <!-- Gaya baru: border dan spacing untuk tiap field -->
        {% for field in form %}
        <div class="flex flex-col">
          <label for="{{ field.id_for_label }}" class="text-sm font-medium text-gray-700 mb-1">
            {{ field.label }}
          </label>
          <div class="border border-gray-300 rounded-lg shadow-sm p-2.5 focus-within:ring-2 focus-within:ring-blue-500 transition">
            {{ field }}
          </div>
          {% if field.help_text %}
            <p class="text-xs text-gray-400 mt-1">{{ field.help_text }}</p>
          {% endif %}
          {% for error in field.errors %}
            <p class="text-xs text-red-500 mt-1">âš  {{ error }}</p>
          {% endfor %}
        </div>
        {% endfor %}
      </div>

      <div class="pt-3">
        <button type="submit"
                class="bg-blue-600 text-white font-medium px-6 py-2.5 rounded-lg hover:bg-blue-700 shadow hover:shadow-md transition">
          Simpan Iklan
        </button>
        <p id="form-message" class="text-sm mt-3"></p>
      </div>
    </form>
  </section>

  <!-- ðŸ”¹ DAFTAR IKLAN -->
  <section class="bg-white border border-gray-100 rounded-2xl shadow-sm p-8">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
        ðŸ“‹ Daftar Iklan
      </h2>
      <span class="text-sm text-gray-500">{{ ads|length }} total iklan</span>
    </div>

    <div id="ads-container">
      {% if ads %}
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for ad in ads %}
            {% include 'partials/ad_card.html' %}
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center text-gray-500 py-10 italic">
          Belum ada iklan yang ditambahkan.
        </div>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const adsContainer = document.getElementById("ads-container");
  const editModal = document.getElementById("edit-modal");
  const editForm = document.getElementById("edit-form");

  // DELETE
  adsContainer.addEventListener("click", async (e) => {
    const btn = e.target.closest(".delete-ad");
    if (!btn) return;
    e.preventDefault();
    if (!confirm("Yakin hapus iklan ini?")) return;

    const res = await fetch(btn.dataset.url, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "X-Requested-With": "XMLHttpRequest"
      },
    });
    const data = await res.json();
    if (data.success) btn.closest("[data-id]").remove();
    else alert("Gagal menghapus iklan.");
  });

  // EDIT (buka modal)
  adsContainer.addEventListener("click", (e) => {
    const btn = e.target.closest(".edit-ad");
    if (!btn) return;
    e.preventDefault();
    editModal.classList.remove("hidden");
    editModal.classList.add("flex");

    editForm.dataset.url = btn.dataset.url;
    document.getElementById("edit-id").value = btn.dataset.id;
    document.getElementById("edit-title").value = btn.dataset.title;
    document.getElementById("edit-link").value = btn.dataset.link;
    document.getElementById("edit-delay").value = btn.dataset.delay;
  });

  // SUBMIT EDIT
  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(editForm);
    const res = await fetch(editForm.dataset.url, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" },
    });
    const data = await res.json();
    if (data.success) {
      const card = document.querySelector(`[data-id="${data.id}"]`);
      card.outerHTML = data.html;
      editModal.classList.add("hidden");
    } else alert("Gagal menyimpan perubahan.");
  });

  // CLOSE MODAL
  document.getElementById("close-modal")?.addEventListener("click", () => {
    editModal.classList.add("hidden");
  });
});
</script>
{% endblock %}
