{% load static %}

<article class="bg-white rounded-xl overflow-hidden card-shadow mb-6" data-post-id="{{ post.id }}">
  <!-- Header -->
  <header class="px-6 py-4 flex items-start gap-4">
    <img src="{% static 'images/user-profile.png' %}" alt="avatar"
         class="w-12 h-12 rounded-full object-cover" />
    <div class="flex-1">
      <div class="flex items-center gap-2 flex-wrap">
        <h3 class="font-semibold text-lg text-gray-900">{{ post.title }}</h3>
        <span class="text-xs text-gray-500">â€¢ {{ post.user.username }}</span>
        <span class="text-xs text-gray-400">| {{ post.created_at|date:"M d, Y" }}</span>
        {% if post.can_edit %}
        <div class="flex items-center gap-2 ml-auto">
          <button class="edit-post-btn text-xs text-blue-600 hover:text-blue-800"
                  data-post-id="{{ post.id }}">Edit</button>
          <button class="delete-post-btn text-xs text-red-600 hover:text-red-800"
                  data-post-id="{{ post.id }}">Delete</button>
        </div>
        {% endif %}
      </div>

      <div class="post-content mt-2">
        <p class="text-gray-700 leading-relaxed whitespace-pre-line">{{ post.content }}</p>
      </div>
    </div>
  </header>

  <!-- Image Section -->
  {% if post.image %}
  <div class="px-6 pb-4">
    <img src="{{ post.image.url }}" alt="Post image"
         class="w-full rounded-lg object-cover max-h-96 cursor-pointer"
         onclick="openImageModal('{{ post.image.url }}')" />
  </div>
  {% endif %}

  <!-- Video Section -->
  {% if post.video_link %}
  <div class="px-6 pb-4">
    <a href="{{ post.video_link }}" target="_blank" rel="noopener noreferrer"
       class="block bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl overflow-hidden border border-gray-200 hover:border-purple-400 hover:shadow-lg transition-all duration-200 group">
      {% if post.video_thumbnail %}
      <div class="relative aspect-video bg-gray-200 overflow-hidden">
        <img src="{{ post.video_thumbnail }}" alt="Video thumbnail"
             class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
             onerror="this.parentElement.innerHTML='<div class=\'flex items-center justify-center h-full bg-gray-300\'><svg class=\'w-16 h-16 text-gray-400\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z\'></path><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M21 12a9 9 0 11-18 0 9 9 0 0118 0z\'></path></svg></div>'">
        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity duration-200 flex items-center justify-center">
          <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center opacity-90 group-hover:opacity-100 transition-opacity">
            <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
          </div>
        </div>
      </div>
      {% else %}
      <div class="aspect-video bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center">
        <svg class="w-20 h-20 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      {% endif %}
      <div class="p-4">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-gray-900 group-hover:text-purple-700 transition-colors mb-1">
              YouTube Video
            </p>
            <p class="text-xs text-gray-500 truncate">{{ post.video_link }}</p>
            <div class="mt-2 flex items-center gap-2">
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
                Open Video
              </span>
            </div>
          </div>
        </div>
      </div>
    </a>
  </div>
  {% endif %}

  <!-- Footer -->
  <footer class="px-6 py-4 border-t border-gray-100">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-6 text-gray-600 text-sm">
        <div class="flex items-center gap-2">
          <span class="font-medium post-likes-count">{{ post.likes_count }}</span><span>likes</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-medium post-dislikes-count">{{ post.dislikes_count }}</span><span>dislikes</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="font-medium">{{ post.comment_count }}</span><span>comments</span>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between border-t border-gray-100 pt-3">
      <div class="flex items-center gap-6">
        <button class="like-btn flex items-center gap-2 text-gray-600 hover:text-pink-600 text-sm transition-colors"
                data-post-id="{{ post.id }}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"
               fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017l-4.246-.06L7 20V11l4.392-5.189c.397-.594.608-1.292.608-2.006 0-.5.405-.905.905-.905H12a2 2 0 012 2v5z"/>
          </svg>
          Like
        </button>

        <button class="dislike-btn flex items-center gap-2 text-gray-600 hover:text-red-600 text-sm transition-colors"
                data-post-id="{{ post.id }}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"
               fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4v9l-4.392 5.189c-.397.594-.608 1.292-.608 2.006 0 .5-.405.905-.905.905H12a2 2 0 01-2-2v-5z"/>
          </svg>
          Dislike
        </button>

        <button class="comment-btn flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors text-sm"
                data-post-id="{{ post.id }}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"
               fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 3.866-4.485 7-10 7S1 15.866 1 12 5.485 5 11 5s10 3.134 10 7z"/>
          </svg>
          Comment
        </button>

        <button class="save-btn flex items-center gap-2 text-gray-600 hover:text-green-600 transition-colors text-sm"
                data-post-id="{{ post.id }}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"
               fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M5 3v16l7-5 7 5V3z"/>
          </svg>
          Save
        </button>
      </div>

      <button class="share-btn flex items-center gap-2 text-gray-600 hover:text-purple-600 transition-colors text-sm"
              data-post-id="{{ post.id }}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"
             fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 6l-4-4-4 4" />
        </svg>
        Share
      </button>
    </div>
  </footer>
</article>


<script>
// Scope handlers to this specific card instance only
(function initCardInteractions() {
  const card = document.currentScript.previousElementSibling;
  if (!card || !card.matches('article[data-post-id]')) return;

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const postId = card.getAttribute('data-post-id');
  const likeBtn = card.querySelector('.like-btn');
  const dislikeBtn = card.querySelector('.dislike-btn');
  const saveBtn = card.querySelector('.save-btn');
  const shareBtn = card.querySelector('.share-btn');
  const likesCountEl = card.querySelector('.post-likes-count');
  const dislikesCountEl = card.querySelector('.post-dislikes-count');

  function toggleLikeButtonView(btn, isActive) {
    if (!btn) return;
    const text = btn.querySelector('.like-text');
    btn.classList.toggle('text-pink-600', isActive);
    btn.classList.toggle('text-gray-600', !isActive);
    if (text) text.textContent = isActive ? 'Liked' : 'Like';
  }

  function toggleDislikeButtonView(btn, isActive) {
    if (!btn) return;
    const text = btn.querySelector('.dislike-text');
    btn.classList.toggle('text-red-600', isActive);
    btn.classList.toggle('text-gray-600', !isActive);
    if (text) text.textContent = isActive ? 'Disliked' : 'Dislike';
  }

  if (likeBtn) {
    likeBtn.addEventListener('click', async function() {
      try {
        const res = await fetch(`/post/api/posts/${postId}/like/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        });
        const data = await res.json();
        if (data.status === 'success') {
          if (likesCountEl) likesCountEl.textContent = data.likes_count;
          if (dislikesCountEl) dislikesCountEl.textContent = data.dislikes_count;
          toggleLikeButtonView(likeBtn, data.user_interaction === 'like');
          toggleDislikeButtonView(dislikeBtn, false);
        } else if (res.status === 401) {
          alert('Silakan login untuk menyukai post.');
        }
      } catch (e) { console.error('Like error', e); }
    });
  }

  if (dislikeBtn) {
    dislikeBtn.addEventListener('click', async function() {
      try {
        const res = await fetch(`/post/api/posts/${postId}/dislike/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        });
        const data = await res.json();
        if (data.status === 'success') {
          if (likesCountEl) likesCountEl.textContent = data.likes_count;
          if (dislikesCountEl) dislikesCountEl.textContent = data.dislikes_count;
          toggleDislikeButtonView(dislikeBtn, data.user_interaction === 'dislike');
          toggleLikeButtonView(likeBtn, false);
        } else if (res.status === 401) {
          alert('Silakan login untuk tidak menyukai post.');
        }
      } catch (e) { console.error('Dislike error', e); }
    });
  }

  if (saveBtn) {
    saveBtn.addEventListener('click', async function() {
      try {
        const res = await fetch(`/post/api/posts/${postId}/save/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        });
        const data = await res.json();
        if (data.status === 'success') {
          const isSaved = data.action === 'saved';
          const svg = saveBtn.querySelector('svg');
          saveBtn.classList.toggle('text-green-600', isSaved);
          if (svg) svg.classList.toggle('fill-green-600', isSaved);
        } else if (res.status === 401) {
          alert('Silakan login untuk menyimpan post.');
        }
      } catch (e) { console.error('Save error', e); }
    });
  }

  if (shareBtn) {
    shareBtn.addEventListener('click', function() {
      const url = window.location.origin + `?post=${postId}`;
      if (navigator.share) {
        navigator.share({ title: 'Smash! Post', url });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url);
        alert('Link disalin ke clipboard');
      } else {
        prompt('Copy URL:', url);
      }
    });
  }
})();
</script>
