{% extends 'base.html' %}
{% load static %}
{% block meta %}
    <title>Smash!</title>
{% endblock meta %}
{% block content %}
    <!doctype html>
    <html lang="en">
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>Smash ‚Äî Home</title>
            <!-- Tailwind CDN for quick prototype -->
            <script src="https://cdn.tailwindcss.com"></script>
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
                  rel="stylesheet">
            <style>
      :root { --bg-soft: #f7fff9; }
      body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
      /* quick custom scrollbar for desktop */
      ::-webkit-scrollbar { height: 12px; width: 12px; }
      ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.08); border-radius: 8px; }
      /* small card shadow like the design */
      .card-shadow { box-shadow: 0 6px 20px rgba(13, 18, 25, 0.06); }
      .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* Modal styles */
      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }
            </style>
        </head>
        <body class="bg-gradient-to-b from-white via-emerald-50 to-pink-50 min-h-screen">
            {% include 'popup_ads.html' %}
            <div class="min-h-screen flex">
            </head>
            <body class="bg-gradient-to-b from-white via-emerald-50 to-pink-50 min-h-screen">
                <div class="min-h-screen flex">
                    <!-- Sidebar -->
                    <aside class="w-64 bg-white/80 border-r border-gray-200 py-8 px-6 hidden lg:block">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold">S</div>
                            <div>
                                <div class="text-xl font-semibold text-purple-800">Smash!</div>
                                <div class="text-xs text-gray-500">Community ‚Ä¢ Padel</div>
                            </div>
                        </div>
                        <nav class="space-y-4 text-sm text-gray-700">
                            <div class="text-xs text-gray-400 uppercase tracking-wide mb-2">Thread</div>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-pink-50 text-pink-700 font-medium"
                               href="#">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     class="h-5 w-5"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8h18M3 16h18" />
                                </svg>
                                Recent
                            </a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#"><span class="text-xl">üè∑Ô∏è</span> For You</a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#"><span class="text-xl">üî•</span> Hot Thread</a>
                            <div class="mt-6 text-xs text-gray-400 uppercase tracking-wide">Menu</div>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#">üîî Notification</a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#">üîñ Bookmark</a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="{% url 'profil:show_views' %}">üë§ Profile</a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#">‚úâÔ∏è Message</a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#">üß© Communities</a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#">‚öôÔ∏è Settings</a>
                            <div class="mt-6 text-xs text-gray-400 uppercase tracking-wide">Others</div>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#">‚ÑπÔ∏è Tentang SMASH</a>
                            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
                               href="#">üìû Hubungi Kami</a>
                            <!-- Logout Button - only show if authenticated -->
                            {% if user.is_authenticated %}
                                <div class="mt-8 pt-4 border-t border-gray-200">
                                    <button id="logout-btn"
                                            class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-50 text-red-600 w-full text-left">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="h-5 w-5"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                        </svg>
                                        Logout
                                    </button>
                                </div>
                            {% else %}
                                <!-- Login/Register buttons for sidebar -->
                                <div class="mt-8 pt-4 border-t border-gray-200 space-y-2">
                                    <a href="{% url 'account:login_register' %}"
                                       class="flex items-center justify-center gap-3 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 w-full">
                                        Register
                                    </a>
                                    <a href="{% url 'account:login_register' %}"
                                       class="flex items-center justify-center gap-3 px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 w-full">
                                        Login
                                    </a>
                                </div>
                            {% endif %}
                            <div class="mt-8 text-xs text-gray-400">¬© 2025 SMASH. All rights reserved.</div>
                        </nav>
                    </aside>
                    <!-- Main content -->
                    <div class="flex-1">
                        <!-- Topbar -->
                        <header class="flex items-center justify-between px-6 py-5 bg-transparent backdrop-blur-sm sticky top-0 z-10">
                            <div class="flex items-center gap-4">
                                <button class="lg:hidden p-2 rounded-md bg-white card-shadow">‚ò∞</button>
                                <div class="hidden lg:flex items-center gap-4">
                                    <div class="text-2xl font-extrabold text-purple-700">Smash!</div>
                                </div>
                                <form class="flex items-center bg-white rounded-full px-4 py-2 shadow-sm w-full max-w-2xl">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         class="h-5 w-5 text-gray-400"
                                         viewBox="0 0 20 20"
                                         fill="currentColor">
                                        <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l4.387 4.387a1 1 0 01-1.414 1.414l-4.387-4.387zM8 14a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd" />
                                    </svg>
                                    <input type="search"
                                           placeholder="Search..."
                                           class="ml-3 outline-none w-full text-sm" />
                                </form>
                            </div>
                            <div class="flex items-center gap-3">
                                <!-- User info and buttons for logged in users -->
                                {% if user.is_authenticated %}
                                    <!-- Create Post Button -->
                                    <button id="create-post-btn"
                                            class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm hover:bg-purple-700 transition-colors flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="h-4 w-4"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                        Create Post
                                    </button>
                                    <span class="text-sm text-gray-700 hidden sm:block">Welcome, {{ user.username }}</span>
                                    <button id="mobile-logout-btn"
                                            class="px-4 py-2 bg-red-600 text-white rounded-md text-sm hidden sm:flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="h-4 w-4"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                        </svg>
                                        Logout
                                    </button>
                                {% else %}
                                    <!-- Login and Register buttons for non-logged in users -->
                                    <a href="{% url 'account:login_register' %}"
                                       class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hidden sm:flex items-center gap-2 hover:bg-blue-700">
                                        Register
                                    </a>
                                    <a href="{% url 'account:login_register' %}"
                                       class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md text-sm hidden sm:flex items-center gap-2 hover:bg-gray-100">
                                        Login
                                    </a>
                                {% endif %}
                            </div>
                        </header>
                        <!-- Filters + main feed -->
                        <main class="px-6 py-8">
                            <div class="flex items-center gap-3 mb-6">
                                <button class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm">Recent</button>
                                <button class="px-3 py-1 rounded-full bg-white text-gray-600 text-sm">For You</button>
                                <button class="px-3 py-1 rounded-full bg-white text-gray-600 text-sm">Hot Thread</button>
                            </div>
                            <!-- Feed column -->
                            <section class="max-w-4xl mx-auto" id="posts-container">
                                <!-- Posts will be loaded here dynamically -->
                                <div id="loading-posts" class="text-center py-12">
                                    <div class="loading-spinner mx-auto mb-4"></div>
                                    <p class="text-gray-500">Loading posts...</p>
                                </div>
                            </section>
                        </main>
                    </div>
                </div>
                <!-- Create Post Modal - Only show if user is authenticated -->
                {% if user.is_authenticated %}
                    <div id="create-post-modal" class="fixed inset-0 z-50 hidden">
                        <div class="modal-backdrop absolute inset-0" id="modal-backdrop"></div>
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden transform transition-all">
                                <!-- Modal Header -->
                                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                                    <h3 class="text-xl font-semibold text-gray-900">Create New Post</h3>
                                    <button id="close-modal"
                                            class="text-gray-400 hover:text-gray-600 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             class="h-6 w-6"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <!-- Modal Body -->
                                <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                                    <form id="create-post-form" class="space-y-4">
                                        {% csrf_token %}
                                        <!-- Title Input -->
                                        <div>
                                            <label for="post-title" class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
                                            <input type="text"
                                                   id="post-title"
                                                   name="title"
                                                   required
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                                   placeholder="What's on your mind?">
                                        </div>
                                        <!-- Content Input -->
                                        <div>
                                            <label for="post-content"
                                                   class="block text-sm font-medium text-gray-700 mb-2">
                                                Content *
                                            </label>
                                            <textarea id="post-content"
                                                      name="content"
                                                      required
                                                      rows="6"
                                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none"
                                                      placeholder="Share your thoughts, experiences, or questions..."></textarea>
                                        </div>
                                        <!-- Image Upload -->
                                        <div>
                                            <label for="post-image" class="block text-sm font-medium text-gray-700 mb-2">Image (Optional)</label>
                                            <input type="file"
                                                   id="post-image"
                                                   name="image"
                                                   accept="image/*"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                            <p class="text-xs text-gray-500 mt-1">Supported formats: JPG, PNG, GIF</p>
                                        </div>
                                        <!-- Video Link -->
                                        <div>
                                            <label for="post-video" class="block text-sm font-medium text-gray-700 mb-2">Video Link (Optional)</label>
                                            <input type="url"
                                                   id="post-video"
                                                   name="video_link"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                                   placeholder="https://youtube.com/...">
                                        </div>
                                        <!-- Form Messages -->
                                        <div id="form-messages" class="hidden"></div>
                                    </form>
                                </div>
                                <!-- Modal Footer -->
                                <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                                    <button type="button"
                                            id="cancel-post"
                                            class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            form="create-post-form"
                                            id="submit-post"
                                            class="px-6 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors flex items-center gap-2">
                                        <span>Create Post</span>
                                        <div id="submit-spinner"
                                             class="hidden loading-spinner border-white border-t-transparent"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                <!-- Image Modal -->
                <div id="image-modal"
                     class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-90">
                    <div class="relative max-w-4xl max-h-full">
                        <button id="close-image-modal"
                                class="absolute top-4 right-4 text-white text-2xl z-10 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-70 transition-colors">
                            √ó
                        </button>
                        <img id="modal-image"
                             src=""
                             alt="Enlarged post image"
                             class="max-w-full max-h-full object-contain">
                    </div>
                </div>
                <!-- JavaScript for dynamic posts, logout, and create post -->
                <script>
      // CSRF Token for AJAX requests
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      const csrftoken = getCookie('csrftoken');

      // Load inline ad once and reuse the HTML
      let inlineAdHtml = '';
      async function loadInlineAdOnce() {
        try {
            const res = await fetch('/ads/api/', { method: 'GET' });
            if (!res.ok) return '';
            const data = await res.json();
            const list = Array.isArray(data?.ads) ? data.ads : [];

            // Filter hanya iklan inline aktif
            const inlineAds = list.filter(a => a && a.ad_type === 'inline' && a.is_active && a.image);
            if (inlineAds.length === 0) return '';

            // Pilih secara acak
            const randomAd = inlineAds[Math.floor(Math.random() * inlineAds.length)];

            // Bangun HTML-nya
            const img = `<img src="${randomAd.image}" alt="${(randomAd.title || 'Advertisement').replaceAll('"','&quot;')}" class="w-full h-44 sm:h-56 object-cover rounded-xl">`;
            const inner = randomAd.link
            ? `<a href="${randomAd.link}" target="_blank" rel="noopener noreferrer" class="block">${img}</a>`
            : img;

            return `<div class="my-6">${inner}</div>`;
        } catch (e) {
            console.error('Failed to load inline ad', e);
            return '';
        }
        }

      // Modal functionality - only initialize if modal exists
      const modal = document.getElementById('create-post-modal');
      const createPostBtn = document.getElementById('create-post-btn');
      const closeModalBtn = document.getElementById('close-modal');
      const cancelPostBtn = document.getElementById('cancel-post');
      const modalBackdrop = document.getElementById('modal-backdrop');
      const createPostForm = document.getElementById('create-post-form');
      const formMessages = document.getElementById('form-messages');

      // Only initialize modal functionality if elements exist (user is authenticated)
      if (modal && createPostBtn) {
        function showModal() {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }

        function hideModal() {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
          if (createPostForm) {
            createPostForm.reset();
          }
          if (formMessages) {
            formMessages.classList.add('hidden');
          }
        }

        function showMessage(message, type) {
          if (formMessages) {
            formMessages.innerHTML = `<div class="p-3 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">${message}</div>`;
            formMessages.classList.remove('hidden');
          }
        }

        // Event listeners for modal
        createPostBtn.addEventListener('click', showModal);
        if (closeModalBtn) closeModalBtn.addEventListener('click', hideModal);
        if (cancelPostBtn) cancelPostBtn.addEventListener('click', hideModal);
        if (modalBackdrop) modalBackdrop.addEventListener('click', hideModal);

        // Handle form submission
        if (createPostForm) {
          createPostForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-post');
            const spinner = document.getElementById('submit-spinner');
            if (!submitBtn) return;
            
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            submitBtn.innerHTML = '<span>Creating...</span>';
            
            try {
              const formData = new FormData(this);
              
              // Create JSON data for non-file fields
              const jsonData = {
                title: formData.get('title'),
                content: formData.get('content'),
                video_link: formData.get('video_link') || ''
              };
              
              console.log('Creating post with data:', jsonData);
              
              // Create new FormData for the request
              const requestData = new FormData();
              requestData.append('data', JSON.stringify(jsonData));
              
              const imageFile = document.getElementById('post-image').files[0];
              if (imageFile) {
                console.log('Uploading image:', imageFile.name);
                requestData.append('image', imageFile);
              }
              
              const response = await fetch('/post/', {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrftoken,
                },
                body: requestData
              });
              
              console.log('Response status:', response.status);
              const data = await response.json();
              console.log('Response data:', data);
              
              if (data.status === 'success') {
                showMessage('Post created successfully!', 'success');
                setTimeout(() => {
                  hideModal();
                  loadPosts(); // Reload posts to show the new one
                }, 1500);
              } else {
                showMessage(data.message || 'Error creating post', 'error');
              }
            } catch (error) {
              console.error('Error creating post:', error);
              showMessage('Network error. Please try again.', 'error');
            } finally {
              // Reset button state
              submitBtn.disabled = false;
              if (spinner) spinner.classList.add('hidden');
              submitBtn.innerHTML = originalText;
            }
          });
        }
      }

      // Load posts from API
      async function loadPosts() {
        console.log('Loading posts...');
        try {
          const response = await fetch('/post/', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            }
          });
          console.log('Response status:', response.status);
          if (!response.ok) throw new Error('Network response was not ok');

          const data = await response.json();
          console.log('Posts data received:', data);
          const container = document.getElementById('posts-container');
          const loading = document.getElementById('loading-posts');
          if (loading) loading.remove();

          if (data.status === 'success' && Array.isArray(data.posts) && data.posts.length > 0) {
            // Load inline ad HTML once
            const chunks = [];
            for (let i = 0; i < data.posts.length; i++) {
            const post = data.posts[i];
            chunks.push(createPostCard(post));

            // Tiap 5 post, ambil satu iklan random
            if ((i + 1) % 5 === 0) {
                const inlineAdHtml = await loadInlineAdOnce();
                if (inlineAdHtml && inlineAdHtml.trim()) {
                chunks.push(inlineAdHtml);
                }
            }
            }

            container.innerHTML = chunks.join('');
            initializePostInteractions();
          } else {
            console.log('No posts found');
            showNoPostsMessage(container);
          }
        } catch (error) {
          console.error('Error loading posts:', error);
          showErrorState(document.getElementById('posts-container'));
        }
      }

      // Function to create post card HTML
      cc

      // Helper function to toggle like button view
      function toggleLikeButtonView(likeBtn, isActive) {
          const likeIcon = likeBtn.querySelector('.like-icon');
          const likeText = likeBtn.querySelector('.like-text');
          
          if (isActive) {
              likeBtn.classList.add('text-pink-600');
              likeBtn.classList.remove('text-gray-600');
              likeIcon.classList.add('fill-pink-600');
              likeText.textContent = 'Liked';
          } else {
              likeBtn.classList.remove('text-pink-600');
              likeBtn.classList.add('text-gray-600');
              likeIcon.classList.remove('fill-pink-600');
              likeText.textContent = 'Like';
          }
      }

      // Helper function to toggle dislike button view
      function toggleDislikeButtonView(dislikeBtn, isActive) {
          const dislikeIcon = dislikeBtn.querySelector('.dislike-icon');
          const dislikeText = dislikeBtn.querySelector('.dislike-text');
          
          if (isActive) {
              dislikeBtn.classList.add('text-red-600');
              dislikeBtn.classList.remove('text-gray-600');
              dislikeIcon.classList.add('fill-red-600');
              dislikeText.textContent = 'Disliked';
          } else {
              dislikeBtn.classList.remove('text-red-600');
              dislikeBtn.classList.add('text-gray-600');
              dislikeIcon.classList.remove('fill-red-600');
              dislikeText.textContent = 'Dislike';
          }
      }

      // Load comments for a post
      async function loadComments(postId) {
          const commentsList = document.querySelector(`.comments-list[data-post-id="${postId}"]`);
          if (!commentsList) return;

          try {
              const response = await fetch(`/comments/post/${postId}/`, {
                  method: 'GET',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': csrftoken,
                  }
              });

              const data = await response.json();
              
              // Remove loading indicator
              const loadingDiv = commentsList.querySelector('.loading-comments');
              if (loadingDiv) loadingDiv.remove();

              if (data.status === 'success' && data.comments && data.comments.length > 0) {
                  commentsList.innerHTML = data.comments.map(comment => createCommentHTML(comment)).join('');
                  initializeCommentInteractions();
              } else {
                  commentsList.innerHTML = `
                      <div class="text-center py-6 text-gray-500 text-sm bg-white rounded-lg">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                          </svg>
                          <p class="font-medium">No comments yet</p>
                          <p class="text-xs text-gray-400 mt-1">Be the first to comment!</p>
                      </div>
                  `;
              }
          } catch (error) {
              console.error('Error loading comments:', error);
              commentsList.innerHTML = `
                  <div class="text-center py-4 text-red-500 text-sm">
                      Error loading comments. Please try again.
                  </div>
              `;
          }
      }

      // Create comment HTML
      function createCommentHTML(comment) {
          const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
          const currentUserId = {{ user.id|default:"null" }};
          const canEdit = isAuthenticated && (comment.user_id === currentUserId);
          
          const isLiked = comment.user_interaction === 'like';
          const isDisliked = comment.user_interaction === 'dislike';

          return `
              <div class="comment-item bg-gray-50 rounded-lg p-4" data-comment-id="${comment.id}">
                  <div class="flex gap-3">
                      <img src="{% static 'images/user-profile.png' %}" alt="${escapeHtml(comment.user)}" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
                      <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                              <span class="font-semibold text-sm text-gray-900">${escapeHtml(comment.user)}</span>
                              <span class="text-xs text-gray-400">${formatDate(comment.created_at)}</span>
                              ${canEdit ? `
                              <button class="delete-comment-btn text-xs text-red-600 hover:text-red-800 ml-auto" data-comment-id="${comment.id}">
                                  Delete
                              </button>
                              ` : ''}
                          </div>
                          <p class="text-sm text-gray-700 mb-2">${escapeHtml(comment.content).replace(/\n/g, '<br>')}</p>
                          ${isAuthenticated ? `
                          <div class="flex items-center gap-4">
                              <button class="comment-like-btn flex items-center gap-1 text-xs ${isLiked ? 'text-pink-600' : 'text-gray-600'} hover:text-pink-600 transition-colors" data-comment-id="${comment.id}">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 comment-like-icon ${isLiked ? 'fill-pink-600' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                  </svg>
                                  <span class="comment-likes-count">${comment.likes_count || 0}</span>
                              </button>
                              <button class="comment-dislike-btn flex items-center gap-1 text-xs ${isDisliked ? 'text-red-600' : 'text-gray-600'} hover:text-red-600 transition-colors" data-comment-id="${comment.id}">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 comment-dislike-icon ${isDisliked ? 'fill-red-600' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
                                  </svg>
                                  <span class="comment-dislikes-count">${comment.dislikes_count || 0}</span>
                              </button>
                          </div>
                          ` : `
                          <div class="flex items-center gap-4 text-xs text-gray-600">
                              <span>${comment.likes_count || 0} likes</span>
                              <span>${comment.dislikes_count || 0} dislikes</span>
                          </div>
                          `}
                      </div>
                  </div>
              </div>
          `;
      }

      // Initialize comment interactions
      function initializeCommentInteractions() {
          // Like comment
          document.querySelectorAll('.comment-like-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const commentId = this.dataset.commentId;
                  const commentItem = this.closest('.comment-item');
                  const likesCount = commentItem.querySelector('.comment-likes-count');
                  const dislikesCount = commentItem.querySelector('.comment-dislikes-count');
                  const likeIcon = this.querySelector('.comment-like-icon');
                  const dislikeBtn = commentItem.querySelector('.comment-dislike-btn');
                  const dislikeIcon = dislikeBtn.querySelector('.comment-dislike-icon');

                  try {
                      const response = await fetch(`/comments/${commentId}/like/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          
                          // Update button states
                          if (data.action === 'liked') {
                              this.classList.add('text-pink-600');
                              this.classList.remove('text-gray-600');
                              likeIcon.classList.add('fill-pink-600');
                              // Remove dislike if active
                              dislikeBtn.classList.remove('text-red-600');
                              dislikeBtn.classList.add('text-gray-600');
                              dislikeIcon.classList.remove('fill-red-600');
                          } else {
                              this.classList.remove('text-pink-600');
                              this.classList.add('text-gray-600');
                              likeIcon.classList.remove('fill-pink-600');
                          }
                      }
                  } catch (error) {
                      console.error('Error liking comment:', error);
                  }
              });
          });

          // Dislike comment
          document.querySelectorAll('.comment-dislike-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const commentId = this.dataset.commentId;
                  const commentItem = this.closest('.comment-item');
                  const likesCount = commentItem.querySelector('.comment-likes-count');
                  const dislikesCount = commentItem.querySelector('.comment-dislikes-count');
                  const dislikeIcon = this.querySelector('.comment-dislike-icon');
                  const likeBtn = commentItem.querySelector('.comment-like-btn');
                  const likeIcon = likeBtn.querySelector('.comment-like-icon');

                  try {
                      const response = await fetch(`/comments/${commentId}/dislike/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          
                          // Update button states
                          if (data.action === 'disliked') {
                              this.classList.add('text-red-600');
                              this.classList.remove('text-gray-600');
                              dislikeIcon.classList.add('fill-red-600');
                              // Remove like if active
                              likeBtn.classList.remove('text-pink-600');
                              likeBtn.classList.add('text-gray-600');
                              likeIcon.classList.remove('fill-pink-600');
                          } else {
                              this.classList.remove('text-red-600');
                              this.classList.add('text-gray-600');
                              dislikeIcon.classList.remove('fill-red-600');
                          }
                      }
                  } catch (error) {
                      console.error('Error disliking comment:', error);
                  }
              });
          });

          // Delete comment
          document.querySelectorAll('.delete-comment-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  if (!confirm('Are you sure you want to delete this comment?')) return;

                  const commentId = this.dataset.commentId;
                  const commentItem = this.closest('.comment-item');

                  try {
                      const response = await fetch(`/comments/${commentId}/`, {
                          method: 'DELETE',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          commentItem.remove();
                      } else {
                          alert('Error deleting comment: ' + data.message);
                      }
                  } catch (error) {
                      console.error('Error deleting comment:', error);
                      alert('Error deleting comment. Please try again.');
                  }
              });
          });
      }

      // Helper function to toggle dislike button view
      function toggleDislikeButtonView(dislikeBtn, isActive) {
          const dislikeIcon = dislikeBtn.querySelector('.dislike-icon');
          const dislikeText = dislikeBtn.querySelector('.dislike-text');
          
          if (isActive) {
              dislikeBtn.classList.add('text-red-600');
              dislikeBtn.classList.remove('text-gray-600');
              dislikeIcon.classList.add('fill-red-600');
              dislikeText.textContent = 'Disliked';
          } else {
              dislikeBtn.classList.remove('text-red-600');
              dislikeBtn.classList.add('text-gray-600');
              dislikeIcon.classList.remove('fill-red-600');
              dislikeText.textContent = 'Dislike';
          }
      }

      function initializePostInteractions() {
          // Like functionality
          document.querySelectorAll('.like-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const postId = this.dataset.postId;
                  const footer = this.closest('footer');
                  const likesCount = footer.querySelector('.post-likes-count');
                  const dislikesCount = footer.querySelector('.post-dislikes-count');
                  const buttonContainer = this.parentElement;
                  const dislikeBtn = buttonContainer.querySelector('.dislike-btn');
                  
                  try {
                      // Call backend API
                      const response = await fetch(`/post/${postId}/like/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          // Update counts from server
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          
                          // Update button views based on current state
                          toggleLikeButtonView(this, data.user_interaction === 'like');
                          toggleDislikeButtonView(dislikeBtn, false);
                      }
                  } catch (error) {
                      console.error('Error liking post:', error);
                  }
              });
          });

          // Dislike functionality
          document.querySelectorAll('.dislike-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const postId = this.dataset.postId;
                  const footer = this.closest('footer');
                  const likesCount = footer.querySelector('.post-likes-count');
                  const dislikesCount = footer.querySelector('.post-dislikes-count');
                  const buttonContainer = this.parentElement;
                  const likeBtn = buttonContainer.querySelector('.like-btn');
                  
                  try {
                      // Call backend API
                      const response = await fetch(`/post/${postId}/dislike/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          // Update counts from server
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          
                          // Update button views based on current state
                          toggleDislikeButtonView(this, data.user_interaction === 'dislike');
                          toggleLikeButtonView(likeBtn, false);
                      }
                  } catch (error) {
                      console.error('Error disliking post:', error);
                  }
              });
          });

          // Edit button functionality
          document.querySelectorAll('.edit-post-btn').forEach(btn => {
              btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const postId = this.dataset.postId;
                  editPost(postId);
              });
          });


          // Delete button functionality
          document.querySelectorAll('.delete-post-btn').forEach(btn => {
              btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const postId = this.dataset.postId;
                  deletePost(postId);
              });
          });
          // Comment toggle
          document.querySelectorAll('.comment-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const postId = this.dataset.postId;
                  const commentsSection = document.getElementById(`comments-${postId}`);
                  if (commentsSection) {
                      const wasHidden = commentsSection.classList.contains('hidden');
                      commentsSection.classList.toggle('hidden');
                      
                      // Load comments when opening the section for the first time
                      if (wasHidden && commentsSection.querySelector('.loading-comments')) {
                          loadComments(postId);
                      }
                  }
              });
          });

          // Add comment form submission
          document.querySelectorAll('.add-comment-form').forEach(form => {
              form.addEventListener('submit', async function(e) {
                  e.preventDefault();
                  
                  const postId = this.dataset.postId;
                  const textarea = this.querySelector('.comment-input');
                  const content = textarea.value.trim();
                  
                  if (!content) return;
                  
                  const submitBtn = this.querySelector('button[type="submit"]');
                  const originalText = submitBtn.innerHTML;
                  submitBtn.disabled = true;
                  submitBtn.innerHTML = '<span>Posting...</span>';
                  
                  try {
                      const response = await fetch(`/comments/post/${postId}/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                          body: JSON.stringify({ content: content })
                      });
                      
                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          textarea.value = '';
                          // Reload comments
                          loadComments(postId);
                      } else {
                          console.error('Server error:', data);
                          alert('Error posting comment: ' + (data.message || 'Unknown error'));
                      }
                  } catch (error) {
                      console.error('Error posting comment:', error);
                      alert('Error posting comment: ' + error.message);
                  } finally {
                      submitBtn.disabled = false;
                      submitBtn.innerHTML = originalText;
                  }
              });
          });

          // Save functionality
          document.querySelectorAll('.save-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  this.classList.toggle('text-green-600');
                  const svg = this.querySelector('svg');
                  if (this.classList.contains('text-green-600')) {
                      svg.classList.add('fill-green-600');
                  } else {
                      svg.classList.remove('fill-green-600');
                  }
              });
          });

          // Share functionality
          document.querySelectorAll('.share-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const postId = this.dataset.postId;
                  
                  // Simple share implementation
                  if (navigator.share) {
                      navigator.share({
                          title: 'Check out this post on Smash!',
                          url: window.location.href + `?post=${postId}`
                      });
                  } else {
                      alert('Post shared! (Copy link to share manually)');
                  }
              });
          });

          // Image modal functionality
          initializeImageModal();
      }

      function initializeImageModal() {
          const modal = document.getElementById('image-modal');
          const modalImage = document.getElementById('modal-image');
          const closeBtn = document.getElementById('close-image-modal');

          if (!modal || !modalImage || !closeBtn) return;

          window.openImageModal = function(imageSrc) {
              modalImage.src = imageSrc;
              modal.classList.remove('hidden');
              document.body.style.overflow = 'hidden';
          };

          closeBtn.addEventListener('click', function() {
              modal.classList.add('hidden');
              document.body.style.overflow = 'auto';
          });

          modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                  modal.classList.add('hidden');
                  document.body.style.overflow = 'auto';
              }
          });
      }

      function showNoPostsMessage(container) {
          if (!container) return;
          container.innerHTML = `
              <div class="text-center py-12">
                  <img src="https://i.pinimg.com/originals/ab/c9/6f/abc96f284c5fd1a927380fe94b07a816.gif" alt="No posts" class="mx-auto w-64 h-64 object-cover rounded-lg">
                  <p class="mt-4 text-gray-500 text-lg">No posts yet</p>
                  <p class="text-gray-400 text-sm">Be the first to create a post!</p>
              </div>
          `;
      }

      function showErrorState(container) {
          if (!container) return;
          const loading = document.getElementById('loading-posts');
          if (loading) loading.remove();
          
          container.innerHTML = `
              <div class="text-center py-12">
                  <img src="https://i.pinimg.com/originals/ab/c9/6f/abc96f284c5fd1a927380fe94b07a816.gif" alt="Error" class="mx-auto w-64 h-64 object-cover rounded-lg">
                  <p class="mt-4 text-gray-500 text-lg">Error loading posts</p>
                  <p class="text-gray-400 text-sm">Please try again later</p>
                  <button onclick="loadPosts()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                      Retry
                  </button>
              </div>
          `;
      }

      // Logout function
      function handleLogout() {
        console.log('Logout function called');
        if (confirm('Are you sure you want to logout?')) {
          console.log('User confirmed logout');
          fetch('/account/logout/ajax/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            console.log('Logout response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Logout response data:', data);
            if (data.success) {
              console.log('Redirecting to:', data.redirect_url);
              window.location.href = data.redirect_url;
            } else {
              alert('Logout failed. Please try again.');
            }
          })
          .catch(error => {
            console.error('Logout error:', error);
            alert('Logout failed: ' + error.message);
          });
        }
      }

      // Utility functions
      function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g , "&lt;") .replace( />/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
        });
      }

      // Event listeners
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        // Load posts when page loads
        loadPosts();

        // Add logout event listeners
        document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
        document.getElementById('mobile-logout-btn')?.addEventListener('click', handleLogout);
      });

      // Edit post function
      function editPost(postId) {
          console.log('Editing post:', postId);
          window.location.href = `/post/edit/${postId}/`;
      }
      // Delete post function
      function deletePost(postId) {
          if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
              fetch(`/post/${postId}/`, {
                  method: 'DELETE',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': csrftoken,
                  }
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      alert('Post deleted successfully!');
                      loadPosts(); // Reload posts
                  } else {
                      alert('Error deleting post: ' + data.message);
                  }
              })
              .catch(error => {
                  console.error('Error deleting post:', error);
                  alert('Error deleting post. Please try again.');
              });
          }
      }
                </script>
            </body>
        </html>
    {% endblock content %}
