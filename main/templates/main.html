{% extends 'base.html' %}
{% load static %}
{% block meta %}
  <title>Smash!</title>
{% endblock meta %}
{% block content %}
  <!doctype html>
  <html lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Smash ‚Äî Home</title>
      <!-- Tailwind CDN for quick prototype -->
      <script src="https://cdn.tailwindcss.com"></script>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
            rel="stylesheet">
      <style>
      :root { --bg-soft: #f7fff9; }
      body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
      /* quick custom scrollbar for desktop */
      ::-webkit-scrollbar { height: 12px; width: 12px; }
      ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.08); border-radius: 8px; }
      /* small card shadow like the design */
      .card-shadow { box-shadow: 0 6px 20px rgba(13, 18, 25, 0.06); }
      .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* Modal styles */
      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }
    </style>
  </head>
  <body class="bg-gradient-to-b from-white via-emerald-50 to-pink-50 min-h-screen">

    <div class="min-h-screen flex">
    </head>
    <body class="bg-gradient-to-b from-white via-emerald-50 to-pink-50 min-h-screen">
      <div class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white/80 border-r border-gray-200 py-8 px-6 hidden lg:block">
          <div class="flex items-center gap-3 mb-8">
            <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold">S</div>
            <div>
              <div class="text-xl font-semibold text-purple-800">Smash!</div>
              <div class="text-xs text-gray-500">Community ‚Ä¢ Padel</div>
            </div>
          </div>
          <nav class="space-y-4 text-sm text-gray-700">
            <div class="text-xs text-gray-400 uppercase tracking-wide mb-2">Thread</div>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-pink-50 text-pink-700 font-medium"
               href="#">
              <svg xmlns="http://www.w3.org/2000/svg"
                   class="h-5 w-5"
                   fill="none"
                   viewBox="0 0 24 24"
                   stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8h18M3 16h18" />
              </svg>
              Recent
            </a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#"><span class="text-xl">üè∑Ô∏è</span> For You</a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#"><span class="text-xl">üî•</span> Hot Thread</a>
            <div class="mt-6 text-xs text-gray-400 uppercase tracking-wide">Menu</div>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#">üîî Notification</a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#">üîñ Bookmark</a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="{% url 'profil:show_views' %}">üë§ Profile</a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#">‚úâÔ∏è Message</a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#">üß© Communities</a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#">‚öôÔ∏è Settings</a>
            <div class="mt-6 text-xs text-gray-400 uppercase tracking-wide">Others</div>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#">‚ÑπÔ∏è Tentang SMASH</a>
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100"
               href="#">üìû Hubungi Kami</a>
            <!-- Logout Button - only show if authenticated -->
            {% if user.is_authenticated %}
              <div class="mt-8 pt-4 border-t border-gray-200">
                <button id="logout-btn"
                        onclick="handleLogout(); return false;"
                        class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-50 text-red-600 w-full text-left">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="h-5 w-5"
                       fill="none"
                       viewBox="0 0 24 24"
                       stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Logout
                </button>
              </div>
            {% else %}
              <!-- Login/Register buttons for sidebar -->
              <div class="mt-8 pt-4 border-t border-gray-200 space-y-2">
                <a href="{% url 'account:login_register' %}"
                   class="flex items-center justify-center gap-3 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 w-full">
                  Register
                </a>
                <a href="{% url 'account:login_register' %}"
                   class="flex items-center justify-center gap-3 px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 w-full">
                  Login
                </a>
              </div>
            {% endif %}
            <div class="mt-8 text-xs text-gray-400">¬© 2025 SMASH. All rights reserved.</div>
          </nav>
        </aside>
        <!-- Main content -->
        <div class="flex-1">
          <!-- Topbar -->
          <header class="flex items-center justify-between px-6 py-5 bg-transparent backdrop-blur-sm sticky top-0 z-10">
            <div class="flex items-center gap-4">
              <button class="lg:hidden p-2 rounded-md bg-white card-shadow">‚ò∞</button>
              <div class="hidden lg:flex items-center gap-4">
                <div class="text-2xl font-extrabold text-purple-700">Smash!</div>
              </div>
              <form class="flex items-center bg-white rounded-full px-4 py-2 shadow-sm w-full max-w-2xl">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-5 w-5 text-gray-400"
                     viewBox="0 0 20 20"
                     fill="currentColor">
                  <path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l4.387 4.387a1 1 0 01-1.414 1.414l-4.387-4.387zM8 14a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd" />
                </svg>
                <input type="search"
                       placeholder="Search..."
                       class="ml-3 outline-none w-full text-sm" />
              </form>
            </div>
            <div class="flex items-center gap-3">
              <!-- User info and logout button for logged in users -->
              {% if user.is_authenticated %}
                <!-- Create Post Button -->
                <button id="create-post-btn"
                        class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm flex items-center gap-2 hover:bg-purple-700">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="h-4 w-4"
                       fill="none"
                       viewBox="0 0 24 24"
                       stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  Create Post
                </button>
                <span class="text-sm text-gray-700 hidden sm:block">Welcome, {{ user.username }}</span>
                <button id="mobile-logout-btn"
                        onclick="handleLogout(); return false;"
                        class="px-4 py-2 bg-red-600 text-white rounded-md text-sm hidden sm:flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="h-4 w-4"
                       fill="none"
                       viewBox="0 0 24 24"
                       stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  Logout
                </button>
              {% else %}
                <!-- Login and Register buttons for non-logged in users -->
                <a href="{% url 'account:login_register' %}"
                   class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hidden sm:flex items-center gap-2 hover:bg-blue-700">
                  Register
                </a>
                <a href="{% url 'account:login_register' %}"
                   class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md text-sm hidden sm:flex items-center gap-2 hover:bg-gray-100">
                  Login
                </a>
              {% endif %}
            </div>
          </header>
          <!-- Filters + main feed -->
          <main class="px-6 py-8">
            <div class="flex items-center gap-3 mb-6">
              <button class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm">Recent</button>
              <button class="px-3 py-1 rounded-full bg-white text-gray-600 text-sm">For You</button>
              <button class="px-3 py-1 rounded-full bg-white text-gray-600 text-sm">Hot Thread</button>
            </div>
            <!-- Feed column -->
            <section class="max-w-4xl mx-auto" id="posts-container">
              <!-- Posts will be loaded here dynamically -->
              <div id="loading-posts" class="text-center py-12">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-500">Loading posts...</p>
              </div>
            </section>
          </main>
        </div>
      </div>
      <!-- Create Post Modal -->
      <div id="modal-backdrop"
           class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"
           onclick="document.getElementById('create-post-modal').classList.add('hidden'); this.classList.add('hidden');">
      </div>
      <div id="create-post-modal"
           class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl z-50">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Create New Post</h2>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-6 w-6"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="create-post-form" class="space-y-4">
          <div>
            <label for="post-title" class="block text-sm font-medium text-gray-700 mb-1">Title*</label>
            <input type="text"
                   id="post-title"
                   name="title"
                   required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                   placeholder="What's on your mind?">
          </div>
          <div>
            <label for="post-content"
                   class="block text-sm font-medium text-gray-700 mb-1">Content*</label>
            <textarea id="post-content"
                      name="content"
                      required
                      rows="6"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                      placeholder="Share your padel experiences, tips, or questions..."></textarea>
          </div>
          <div>
            <label for="post-image" class="block text-sm font-medium text-gray-700 mb-1">Image (optional)</label>
            <input type="file"
                   id="post-image"
                   name="image"
                   accept="image/*"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
          </div>
          <div>
            <label for="post-video" class="block text-sm font-medium text-gray-700 mb-1">Video Link (optional)</label>
            <input type="url"
                   id="post-video"
                   name="video_link"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                   placeholder="https://youtube.com/watch?v=...">
          </div>
          <div id="message-container" class="hidden p-3 rounded-lg"></div>
          <div class="flex items-center justify-end gap-3 pt-4">
            <button type="button"
                    id="cancel-post"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100">Cancel</button>
            <button type="submit"
                    id="submit-post"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
              <span id="submit-spinner" class="hidden loading-spinner w-4 h-4"></span>
              <span>Post</span>
            </button>
          </div>
        </form>
      </div>
      <!-- JavaScript for dynamic posts and logout -->
      <script>
      // CSRF Token for AJAX requests
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      const csrftoken = getCookie('csrftoken');

      // Modal functionality
      function showModal() {
        console.log('üìù Opening create post modal');
        const modal = document.getElementById('create-post-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        if (modal && modalBackdrop) {
          modal.classList.remove('hidden');
          modalBackdrop.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }

      function hideModal() {
        console.log('‚úñÔ∏è Closing modal');
        const modal = document.getElementById('create-post-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const createPostForm = document.getElementById('create-post-form');
        const formMessages = document.getElementById('message-container');
        
        if (modal && modalBackdrop) {
          modal.classList.add('hidden');
          modalBackdrop.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
        if (createPostForm) {
          createPostForm.reset();
        }
        if (formMessages) {
          formMessages.classList.add('hidden');
        }
      }

      function showMessage(message, type) {
        const formMessages = document.getElementById('message-container');
        if (formMessages) {
          formMessages.innerHTML = `<div class="p-3 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">${message}</div>`;
          formMessages.classList.remove('hidden');
        }
      }

      // Load posts from API
      function loadPosts() {
          fetch('/post/', {
              method: 'GET',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrftoken
              }
          })
          .then(response => response.json())
          .then(data => {
              const container = document.getElementById('posts-container');
              const loading = document.getElementById('loading-posts');
              
              if (loading) {
                  loading.remove();
              }

              if (data.status === 'success' && data.posts && data.posts.length > 0) {
                  container.innerHTML = data.posts.map(post => createPostCard(post)).join('');
                  initializePostInteractions();
              } else {
                  showNoPostsMessage(container);
              }
          })
          .catch(error => {
              console.error('Error loading posts:', error);
              showErrorState(container);
          });
      }

      // Function to create post card HTML
      function createPostCard(post) {
          const editButtons = post.can_edit ? `
              <div class="flex items-center gap-2 ml-auto">
                  <button class="edit-post-btn text-xs text-blue-600 hover:text-blue-800" data-post-id="${post.id}">
                      Edit
                  </button>
                  <button class="delete-post-btn text-xs text-red-600 hover:text-red-800" data-post-id="${post.id}">
                      Delete
                  </button>
              </div>
          ` : '';

          const imageSection = post.image ? `
              <div class="px-6 pb-4">
                  <img src="${post.image}" alt="Post image" class="w-full rounded-lg object-cover max-h-96 cursor-pointer post-image" onclick="openImageModal('${post.image}')" />
              </div>
          ` : '';

          let videoSection = '';
          if (post.video_link) {
              if (post.video_link.includes('youtube.com') || post.video_link.includes('youtu.be')) {
                  const embedUrl = post.video_link.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/');
                  videoSection = `
                      <div class="px-6 pb-4">
                          <div class="relative aspect-video bg-gray-100 rounded-lg overflow-hidden">
                              <iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                              </iframe>
                          </div>
                      </div>
                  `;
              } else {
                  videoSection = `
                      <div class="px-6 pb-4">
                          <div class="relative aspect-video bg-gray-100 rounded-lg overflow-hidden">
                              <video controls class="w-full h-full">
                                  <source src="${post.video_link}" type="video/mp4">
                                  Your browser does not support the video tag.
                              </video>
                          </div>
                      </div>
                  `;
              }
          }

          return `
              <div class="post-card" data-post-id="${post.id}">
                  <article class="bg-white rounded-xl overflow-hidden card-shadow mb-6">
                      <header class="px-6 py-4 flex items-start gap-4">
                          <img src="https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=400&auto=format&fit=crop&ixlib=rb-4.0.3&s=3e1f8e3e6b9f7a1d9b6dd7e6a4c4c0a9" alt="avatar" class="w-12 h-12 rounded-full object-cover" />
                          <div class="flex-1">
                              <div class="flex items-center gap-2 flex-wrap">
                                  <h3 class="font-semibold text-lg text-gray-900">${escapeHtml(post.title)}</h3>
                                  <span class="text-xs text-gray-500">‚Ä¢ ${escapeHtml(post.user)}</span>
                                  <span class="text-xs text-gray-400">| ${formatDate(post.created_at)}</span>
                                  ${editButtons}
                              </div>
                              
                              <div class="post-content mt-2">
                                  <p class="text-gray-700 leading-relaxed">
                                      ${escapeHtml(post.content).replace(/\n/g, '<br>')}
                                  </p>
                              </div>
                          </div>
                      </header>

                      ${imageSection}
                      ${videoSection}

                      <footer class="px-6 py-4 border-t border-gray-100">
                          <div class="flex items-center justify-between mb-3">
                              <div class="flex items-center gap-6 text-gray-600 text-sm">
                                  <div class="flex items-center gap-2">
                                      <span class="font-medium post-likes-count">0</span>
                                      <span>likes</span>
                                  </div>
                                  <div class="flex items-center gap-2">
                                      <span class="font-medium">${post.comment_count || 0}</span>
                                      <span>comments</span>
                                  </div>
                                  <div class="flex items-center gap-2">
                                      <span class="font-medium post-shares-count">0</span>
                                      <span>shares</span>
                                  </div>
                              </div>
                          </div>

                          <div class="flex items-center justify-between border-t border-gray-100 pt-3">
                              <div class="flex items-center gap-6">
                                  <button class="like-btn flex items-center gap-2 text-gray-600 hover:text-pink-600 transition-colors text-sm" data-post-id="${post.id}">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 like-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                      </svg>
                                      <span class="like-text">Like</span>
                                  </button>

                                  <button class="comment-btn flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors text-sm" data-post-id="${post.id}">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 3.866-4.485 7-10 7S1 15.866 1 12 5.485 5 11 5s10 3.134 10 7z" />
                                      </svg>
                                      Comment
                                  </button>

                                  <button class="save-btn flex items-center gap-2 text-gray-600 hover:text-green-600 transition-colors text-sm" data-post-id="${post.id}">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v16l7-5 7 5V3z" />
                                      </svg>
                                      Save
                                  </button>
                              </div>

                              <button class="share-btn flex items-center gap-2 text-gray-600 hover:text-purple-600 transition-colors text-sm" data-post-id="${post.id}">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7" />
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 6l-4-4-4 4" />
                                  </svg>
                                  Share
                              </button>
                          </div>

                          <div class="comments-section mt-4 hidden" id="comments-${post.id}">
                              <div class="space-y-3">
                                  <!-- Comments will be loaded here -->
                              </div>
                              
                              <div class="mt-4 pt-3 border-t border-gray-100">
                                  <form class="add-comment-form" data-post-id="${post.id}">
                                      <div class="flex gap-3">
                                          <input type="text" placeholder="Write a comment..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                              Post
                                          </button>
                                      </div>
                                  </form>
                              </div>
                          </div>
                      </footer>
                  </article>
              </div>
          `;
      }

      function initializePostInteractions() {
          // Like functionality
          document.querySelectorAll('.like-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const postId = this.dataset.postId;
                  const likeIcon = this.querySelector('.like-icon');
                  const likeText = this.querySelector('.like-text');
                  const likesCount = this.closest('footer').querySelector('.post-likes-count');
                  
                  this.classList.toggle('text-pink-600');
                  likeIcon.classList.toggle('fill-pink-600');
                  
                  if (this.classList.contains('text-pink-600')) {
                      likeText.textContent = 'Liked';
                      likesCount.textContent = (parseInt(likesCount.textContent) || 0) + 1;
                  } else {
                      likeText.textContent = 'Like';
                      likesCount.textContent = Math.max((parseInt(likesCount.textContent) || 1) - 1, 0);
                  }
              });
          });

          // Comment toggle
          document.querySelectorAll('.comment-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const postId = this.dataset.postId;
                  const commentsSection = document.getElementById(`comments-${postId}`);
                  commentsSection.classList.toggle('hidden');
              });
          });

          // Save functionality
          document.querySelectorAll('.save-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  this.classList.toggle('text-green-600');
                  const svg = this.querySelector('svg');
                  if (this.classList.contains('text-green-600')) {
                      svg.classList.add('fill-green-600');
                  } else {
                      svg.classList.remove('fill-green-600');
                  }
              });
          });

          // Share functionality
          document.querySelectorAll('.share-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const postId = this.dataset.postId;
                  const sharesCount = this.closest('footer').querySelector('.post-shares-count');
                  sharesCount.textContent = (parseInt(sharesCount.textContent) || 0) + 1;
                  
                  // Simple share implementation
                  if (navigator.share) {
                      navigator.share({
                          title: 'Check out this post on Smash!',
                          url: window.location.href + `?post=${postId}`
                      });
                  } else {
                      alert('Post shared! (Copy link to share manually)');
                  }
              });
          });

          // Image modal functionality
          initializeImageModal();
      }

      function initializeImageModal() {
          const modal = document.getElementById('image-modal');
          const modalImage = document.getElementById('modal-image');
          const closeBtn = document.getElementById('close-image-modal');

          window.openImageModal = function(imageSrc) {
              modalImage.src = imageSrc;
              modal.classList.remove('hidden');
              document.body.style.overflow = 'hidden';
          };

          closeBtn.addEventListener('click', function() {
              modal.classList.add('hidden');
              document.body.style.overflow = 'auto';
          });

          modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                  modal.classList.add('hidden');
                  document.body.style.overflow = 'auto';
              }
          });
      }

      function showNoPostsMessage(container) {
          container.innerHTML = `
              <div class="text-center py-12">
                  <img src="https://i.pinimg.com/originals/ab/c9/6f/abc96f284c5fd1a927380fe94b07a816.gif" alt="No posts" class="mx-auto w-64 h-64 object-cover rounded-lg">
                  <p class="mt-4 text-gray-500 text-lg">No posts yet</p>
                  <p class="text-gray-400 text-sm">Be the first to create a post!</p>
              </div>
          `;
      }

      function showErrorState(container) {
          const loading = document.getElementById('loading-posts');
          if (loading) loading.remove();
          
          container.innerHTML = `
              <div class="text-center py-12">
                  <img src="https://i.pinimg.com/originals/ab/c9/6f/abc96f284c5fd1a927380fe94b07a816.gif" alt="Error" class="mx-auto w-64 h-64 object-cover rounded-lg">
                  <p class="mt-4 text-gray-500 text-lg">Error loading posts</p>
                  <p class="text-gray-400 text-sm">Please try again later</p>
                  <button onclick="loadPosts()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                      Retry
                  </button>
              </div>
          `;
      }

      // Logout function
      function handleLogout() {
        console.log('Logout function called');
        if (confirm('Are you sure you want to logout?')) {
          console.log('User confirmed logout');
          fetch('/account/logout/ajax/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            console.log('Logout response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Logout response data:', data);
            if (data.success) {
              console.log('Redirecting to:', data.redirect_url);
              window.location.href = data.redirect_url;
            } else {
              alert('Logout failed. Please try again.');
            }
          })
          .catch(error => {
            console.error('Logout error:', error);
            alert('Logout failed: ' + error.message);
          });
        }
      }

      // Utility functions
      function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g , "&lt;") .replace( />/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
        });
      }

      // Event listeners
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize modal elements
        const modal = document.getElementById('create-post-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const createPostBtn = document.getElementById('create-post-btn');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelPostBtn = document.getElementById('cancel-post');
        const createPostForm = document.getElementById('create-post-form');
        
        console.log('Modal elements initialized:', {
          modal: !!modal,
          modalBackdrop: !!modalBackdrop,
          createPostBtn: !!createPostBtn,
          closeModalBtn: !!closeModalBtn,
          cancelPostBtn: !!cancelPostBtn,
          createPostForm: !!createPostForm
        });
        
        // Event listeners for modal
        if (createPostBtn) {
          createPostBtn.addEventListener('click', function() {
            console.log('Create post button clicked');
            showModal();
          });
        }
        
        if (closeModalBtn) {
          closeModalBtn.addEventListener('click', function() {
            console.log('Close modal button clicked');
            hideModal();
          });
        }
        
        if (cancelPostBtn) {
          cancelPostBtn.addEventListener('click', function() {
            console.log('Cancel post button clicked');
            hideModal();
          });
        }
        
        if (modalBackdrop) {
          modalBackdrop.addEventListener('click', function() {
            console.log('Modal backdrop clicked');
            hideModal();
          });
        }
        
        // Handle form submission
        if (createPostForm) {
          createPostForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            const submitBtn = document.getElementById('submit-post');
            const spinner = document.getElementById('submit-spinner');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            spinner.classList.remove('hidden');
            submitBtn.innerHTML = '<span>Creating...</span>';
            
            try {
              const formData = new FormData(this);
              
              // Create JSON data for non-file fields
              const jsonData = {
                title: formData.get('title'),
                content: formData.get('content'),
                video_link: formData.get('video_link') || ''
              };
              
              // Create new FormData for the request
              const requestData = new FormData();
              requestData.append('data', JSON.stringify(jsonData));
              
              const imageFile = document.getElementById('post-image').files[0];
              if (imageFile) {
                requestData.append('image', imageFile);
              }
              
              console.log('Sending post data:', jsonData);
              
              const response = await fetch('/post/', {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrftoken,
                },
                body: requestData
              });
              
              const data = await response.json();
              console.log('Post creation response:', data);
              
              if (data.status === 'success') {
                showMessage('Post created successfully!', 'success');
                setTimeout(() => {
                  console.log('Hiding modal and reloading posts');
                  hideModal();
                  loadPosts(); // Reload posts to show the new one
                }, 1500);
              } else {
                showMessage(data.message || 'Error creating post', 'error');
              }
            } catch (error) {
              console.error('Error creating post:', error);
              showMessage('Network error. Please try again.', 'error');
            } finally {
              // Reset button state
              submitBtn.disabled = false;
              spinner.classList.add('hidden');
              submitBtn.innerHTML = originalText;
            }
          });
        }
        
        // Handle delete post with event delegation
        document.addEventListener('click', async function(e) {
          if (e.target.classList.contains('delete-post-btn')) {
            const postId = e.target.getAttribute('data-post-id');
            
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
              return;
            }
            
            console.log('Deleting post:', postId);
            
            try {
              const response = await fetch(`/post/${postId}/`, {
                method: 'DELETE',
                headers: {
                  'X-CSRFToken': csrftoken,
                  'Content-Type': 'application/json'
                }
              });
              
              const data = await response.json();
              console.log('Delete response:', data);
              
              if (data.status === 'success') {
                // Remove the post card from DOM
                const postCard = e.target.closest('.bg-white');
                if (postCard) {
                  postCard.style.transition = 'opacity 0.3s ease-out';
                  postCard.style.opacity = '0';
                  setTimeout(() => {
                    postCard.remove();
                  }, 300);
                }
                
                // Show success message (you can add a toast notification here)
                console.log('‚úÖ Post deleted successfully');
              } else {
                alert(data.message || 'Error deleting post');
              }
            } catch (error) {
              console.error('Error deleting post:', error);
              alert('Network error. Please try again.');
            }
          }
        });
        
        // Load posts when page loads
        loadPosts();

        // Add logout event listeners
        document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
        document.getElementById('mobile-logout-btn')?.addEventListener('click', handleLogout);
      });
      </script>
    </body>
  </html>
{% endblock content %}
