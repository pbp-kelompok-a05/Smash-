{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Profile - Smash</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-white/80 border-r border-gray-200 py-8 px-6 hidden lg:block">
    <div class="flex items-center gap-3 mb-8">
      <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold">S</div>
      <div>
        <div class="text-xl font-semibold text-purple-800">Smash!</div>
        <div class="text-xs text-gray-500">Community • Padel</div>
      </div>
    </div>
    <nav class="space-y-4 text-sm text-gray-700">
      <div class="text-xs text-gray-400 uppercase tracking-wide mb-2">Thread</div>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="{% url 'main:home' %}">
        <svg xmlns="http://www.w3.org/2000/svg " class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8h18M3 16h18" /></svg>
        Recent
      </a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#"><span class="text-xl">🏷️</span> For You</a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#"><span class="text-xl">🔥</span> Hot Thread</a>

      <div class="mt-6 text-xs text-gray-400 uppercase tracking-wide">Menu</div>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#">🔔 Notification</a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#">🔖 Bookmark</a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-pink-50 text-pink-700 font-medium" href="{% url 'profil:show_views' %}">👤 Profile</a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#">✉️ Message</a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#">🧩 Communities</a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#">⚙️ Settings</a>

      <div class="mt-6 text-xs text-gray-400 uppercase tracking-wide">Others</div>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#">ℹ️ Tentang SMASH</a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100" href="#">📞 Hubungi Kami</a>

      {% if user.is_authenticated %}
        <div class="mt-8 pt-4 border-t border-gray-200">
          <button id="logout-btn" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-50 text-red-600 w-full text-left">
            <svg xmlns="http://www.w3.org/2000/svg " class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            Logout
          </button>
        </div>
      {% else %}
        <div class="mt-8 pt-4 border-t border-gray-200 space-y-2">
          <a href="{% url 'account:login_register' %}" class="flex items-center justify-center gap-3 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 w-full">Register</a>
          <a href="{% url 'account:login_register' %}" class="flex items-center justify-center gap-3 px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 w-full">Login</a>
        </div>
      {% endif %}
      <div class="mt-8 text-xs text-gray-400">© 2025 SMASH. All rights reserved.</div>
    </nav>
  </aside>

  <div class="flex-1 flex flex-col">
    <!-- Topbar -->
    <header class="flex items-center justify-between px-6 py-5 bg-white/80 backdrop-blur sticky top-0 z-10">
      <div class="flex items-center gap-4">
        <button class="lg:hidden p-2 rounded-md bg-white card-shadow">☰</button>
        <div class="hidden lg:flex items-center gap-4">
          <div class="text-2xl font-extrabold text-purple-700">Smash!</div>
        </div>
        <form class="flex items-center bg-white rounded-full px-4 py-2 shadow-sm w-full max-w-2xl">
          <svg xmlns="http://www.w3.org/2000/svg " class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l4.387 4.387a1 1 0 01-1.414 1.414l-4.387-4.387zM8 14a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd" /></svg>
          <input type="search" placeholder="Search..." class="ml-3 outline-none w-full text-sm" />
        </form>
      </div>

      <div class="flex items-center gap-3">
        {% if user.is_authenticated %}
          <button id="create-post-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm hover:bg-purple-700 transition-colors flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg " class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Create Post
          </button>
          <span class="text-sm text-gray-700 hidden sm:block">Welcome, {{ user.username }}</span>
          <button id="mobile-logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm hidden sm:flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg " class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            Logout
          </button>
        {% else %}
          <a href="{% url 'account:login_register' %}" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hidden sm:flex items-center gap-2 hover:bg-blue-700">Register</a>
          <a href="{% url 'account:login_register' %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md text-sm hidden sm:flex items-center gap-2 hover:bg-gray-100">Login</a>
        {% endif %}
      </div>
    </header>

    <!-- Main Profile Content -->
    <main class="flex-1 px-6 py-8 overflow-y-auto">
      <div class="max-w-4xl mx-auto bg-gray-100 rounded-xl p-8 mt-6 shadow-lg">
        <div class="bg-white rounded-xl p-6 shadow mb-6">
          <div class="flex items-center space-x-6">
            <img src="{% static 'images/user-profile.png' %}" alt="Profil" class="rounded-full w-20 h-20" />
            <div>
              <h2 class="text-lg">Hello,</h2>
              <h1 id="profile-name" class="text-4xl font-extrabold">{{ user.username }}</h1>
              <p id="user-bio" class="text-gray-600 mt-1">{{ bio|default:"Belum ada bio" }}</p>
            </div>
          </div>

          <a href="{% url 'profil:edit_or_create_profile' %}" class="inline-block mt-4">
            <button class="px-4 py-2 rounded-lg font-medium text-white bg-blue-500 hover:bg-blue-600 transition">+ edit bio</button>
          </a>

          <div class="flex gap-3 mt-4">
            <button id="filter-my" class="px-4 py-2 rounded-lg font-medium text-white bg-blue-500 hover:bg-blue-600 transition">My Posts</button>
            <button id="filter-bookmark" class="px-4 py-2 rounded-lg font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 transition">Bookmark</button>
            <button id="filter-like" class="px-4 py-2 rounded-lg font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 transition">Liked</button>
          </div>
        </div>

        <section class="max-w-4xl mx-auto" id="posts-container">
            {% if posts %}
                {% for p in posts %}
                    <article class="bg-white rounded-xl overflow-hidden card-shadow mb-6">
                        <header class="px-6 py-4 flex items-start gap-4">
                            <img src="{% static 'images/user-profile.png' %}" alt="avatar" class="w-12 h-12 rounded-full object-cover" />
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-semibold text-gray-900">{{ p.user.username }}</h3>
                                    <span class="text-xs text-gray-400">{{ p.created_at|date:"M d, Y H:i" }}</span>
                                </div>
                                <h2 class="text-lg font-bold text-gray-900 mt-1">{{ p.title }}</h2>
                            </div>
                        </header>
                        <div class="px-6 pb-6 text-gray-700">
                            {{ p.content|linebreaksbr|truncatechars:240 }}
                        </div>
                    </article>
                {% endfor %}
            {% else %}
            <!-- Placeholder while JS fetch loads -->
            <div id="loading-posts" class="text-center py-12">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-500">Loading posts...</p>
            </div>
            {% endif %}
        </section>
        <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
          <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg " fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <p class="text-gray-600 mt-3">Loading posts...</p>
        </div>
        <div id="error" class="hidden"></div>
        <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
          <div class="w-32 h-32 mx-auto mb-4">
            <img src="{% static 'image/no-post.png' %}" alt="No post available" class="w-full h-full object-contain">
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No post found</h3>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ===== MODALS ===== -->
{% if user.is_authenticated %}
<!-- Create Post Modal -->
<div id="create-post-modal" class="fixed inset-0 z-50 hidden">
  <div class="modal-backdrop absolute inset-0" id="modal-backdrop"></div>
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden transform transition-all">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-xl font-semibold text-gray-900">Create New Post</h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg " class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
        <form id="create-post-form" class="space-y-4">
          {% csrf_token %}
          <div>
            <label for="post-title" class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
            <input type="text" id="post-title" name="title" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="What's on your mind?">
          </div>
          <div>
            <label for="post-content" class="block text-sm font-medium text-gray-700 mb-2">Content *</label>
            <textarea id="post-content" name="content" required rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none" placeholder="Share your thoughts, experiences, or questions..."></textarea>
          </div>
          <div>
            <label for="post-image" class="block text-sm font-medium text-gray-700 mb-2">Image (Optional)</label>
            <input type="file" id="post-image" name="image" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
            <p class="text-xs text-gray-500 mt-1">Supported formats: JPG, PNG, GIF</p>
          </div>
          <div>
            <label for="post-video" class="block text-sm font-medium text-gray-700 mb-2">Video Link (Optional)</label>
            <input type="url" id="post-video" name="video_link" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="https://youtube.com/  ...">
          </div>
          <div id="form-messages" class="hidden"></div>
        </form>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
        <button type="button" id="cancel-post" class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">Cancel</button>
        <button type="submit" form="create-post-form" id="submit-post" class="px-6 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors flex items-center gap-2">
          <span>Create Post</span>
          <div id="submit-spinner" class="hidden loading-spinner border-white border-t-transparent"></div>
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-90">
  <div class="relative max-w-4xl max-h-full">
    <button id="close-image-modal" class="absolute top-4 right-4 text-white text-2xl z-10 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-70 transition-colors">&times;</button>
    <img id="modal-image" src="" alt="Enlarged post image" class="max-w-full max-h-full object-contain">
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
  document.getElementById('mobile-logout-btn')?.addEventListener('click', handleLogout);

      // Logout function
      function handleLogout() {
        console.log('Logout function called');
        if (confirm('Are you sure you want to logout?')) {
          console.log('User confirmed logout');
          fetch('/account/logout/ajax/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            console.log('Logout response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Logout response data:', data);
            if (data.success) {
              console.log('Redirecting to:', data.redirect_url);
              window.location.href = data.redirect_url;
            } else {
              alert('Logout failed. Please try again.');
            }
          })
          .catch(error => {
            console.error('Logout error:', error);
            alert('Logout failed: ' + error.message);
          });
        }
      }

  // Modal behaviour (create & image)
  const modal = document.getElementById('create-post-modal');
  const createPostBtn = document.getElementById('create-post-btn');
  const closeModalBtn = document.getElementById('close-modal');
  const cancelPostBtn = document.getElementById('cancel-post');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const createPostForm = document.getElementById('create-post-form');
  const formMessages = document.getElementById('form-messages');

  function showModal() {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function hideModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    createPostForm.reset();
    formMessages.classList.add('hidden');
  }
  function showMessage(msg, type) {
    formMessages.innerHTML = `<div class="p-3 rounded-lg ${type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">${msg}</div>`;
    formMessages.classList.remove('hidden');
  }

  createPostBtn?.addEventListener('click', showModal);
  closeModalBtn?.addEventListener('click', hideModal);
  cancelPostBtn?.addEventListener('click', hideModal);
  modalBackdrop?.addEventListener('click', hideModal);

  createPostForm?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submit-post');
    const spinner = document.getElementById('submit-spinner');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    spinner.classList.remove('hidden');
    submitBtn.innerHTML = '<span>Creating...</span>';

    try {
      const formData = new FormData(this);
      const jsonData = {
        title: formData.get('title'),
        content: formData.get('content'),
        video_link: formData.get('video_link') || ''
      };
      const requestData = new FormData();
      requestData.append('data', JSON.stringify(jsonData));
      const imageFile = document.getElementById('post-image').files[0];
      if (imageFile) requestData.append('image', imageFile);

      const response = await fetch('/post/api/posts/', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: requestData
      });
      const data = await response.json();
      if (data.status === 'success') {
        showMessage('Post created successfully!', 'success');
        setTimeout(() => {
          hideModal();
          loadPosts(); // reload posts
        }, 1500);
      } else {
        showMessage(data.message || 'Error creating post', 'error');
      }
    } catch (error) {
      console.error(error);
      showMessage('Network error. Please try again.', 'error');
    } finally {
      submitBtn.disabled = false;
      spinner.classList.add('hidden');
      submitBtn.innerHTML = originalText;
    }
  });

  // Image modal
  const imageModal = document.getElementById('image-modal');
  const modalImage = document.getElementById('modal-image');
  const closeImageModalBtn = document.getElementById('close-image-modal');

  window.openImageModal = function(src) {
    modalImage.src = src;
    imageModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  };
  closeImageModalBtn?.addEventListener('click', () => {
    imageModal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  });
  imageModal?.addEventListener('click', (e) => {
    if (e.target === imageModal) {
      imageModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
  });

  // Profile-page post logic
  const CURRENT_USER_ID = {{ user.id|default:"null" }};
  const postContainer = document.getElementById('posts-list');
  const showMyPostButton = document.getElementById('filter-my');
  const showMyBookmarkButton = document.getElementById('filter-bookmark');
  const showMyLikesButton = document.getElementById('filter-like');
  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');

  let activeFilter = 'my';
  let allPostData = [];

  function updateFilterButtonsAppearance() {
    const base = 'px-4 py-2 rounded-lg font-medium transition';
    showMyPostButton.className = base + (activeFilter === 'my' ? ' text-white bg-blue-500 hover:bg-blue-600' : ' text-gray-700 bg-gray-100 hover:bg-gray-200');
    showMyBookmarkButton.className = base + (activeFilter === 'bookmark' ? ' text-white bg-blue-500 hover:bg-blue-600' : ' text-gray-700 bg-gray-100 hover:bg-gray-200');
    showMyLikesButton.className = base + (activeFilter === 'liked' ? ' text-white bg-blue-500 hover:bg-blue-600' : ' text-gray-700 bg-gray-100 hover:bg-gray-200');
  }

  function displayPageSection({ showLoading = false, showError = false, showEmpty = false }) {
    loadingSpinner.classList.toggle('hidden', !showLoading);
    errorMessage.classList.toggle('hidden', !showError);
    emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  }

  function createPostCard(post) {
        console.log('Creating card for post:', post);
        // Check if user is authenticated
        const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        post.is_authenticated = isAuthenticated;
        
        const editButtons = post.can_edit ? `
            <div class="flex items-center gap-2 ml-auto">
                <button class="edit-post-btn text-xs text-blue-600 hover:text-blue-800" data-post-id="${post.id}">
                    Edit
                </button>
                <button class="delete-post-btn text-xs text-red-600 hover:text-red-800" data-post-id="${post.id}">
                    Delete
                </button>
            </div>
        ` : '';

        const imageSection = post.image ? `
            <div class="px-6 pb-4">
                <img src="${post.image}" alt="Post image" class="w-full rounded-lg object-cover max-h-96 cursor-pointer post-image" onclick="openImageModal('${post.image}')" />
            </div>
        ` : '';

        let videoSection = '';
        if (post.video_link) {
            // Extract video information
            let videoThumbnail = '';
            let videoTitle = post.video_link;
            let videoId = '';
            
            if (post.video_link.includes('youtube.com') || post.video_link.includes('youtu.be')) {
                // Extract YouTube video ID
                if (post.video_link.includes('youtu.be/')) {
                    videoId = post.video_link.split('youtu.be/')[1].split('?')[0].split('&')[0];
                } else if (post.video_link.includes('youtube.com/watch')) {
                    const urlParams = new URLSearchParams(post.video_link.split('?')[1]);
                    videoId = urlParams.get('v');
                } else if (post.video_link.includes('youtube.com/embed/')) {
                    videoId = post.video_link.split('youtube.com/embed/')[1].split('?')[0].split('&')[0];
                }
                
                if (videoId) {
                    videoThumbnail = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                    videoTitle = 'YouTube Video';
                }
            }
            
            // Create clickable video card
            videoSection = `
                <div class="px-6 pb-4">
                    <a href="${post.video_link}" target="_blank" rel="noopener noreferrer" class="block bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl overflow-hidden border border-gray-200 hover:border-purple-400 hover:shadow-lg transition-all duration-200 group">
                        ${videoThumbnail ? `
                        <div class="relative aspect-video bg-gray-200 overflow-hidden">
                            <img src="${videoThumbnail}" alt="Video thumbnail" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200" onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center h-full bg-gray-300\\'><svg class=\\'w-16 h-16 text-gray-400\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z\\'></path><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M21 12a9 9 0 11-18 0 9 9 0 0118 0z\\'></path></svg></div>'">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity duration-200 flex items-center justify-center">
                                <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center opacity-90 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="aspect-video bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center">
                            <svg class="w-20 h-20 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        `}
                        <div class="p-4">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-semibold text-gray-900 group-hover:text-purple-700 transition-colors mb-1">${escapeHtml(videoTitle)}</p>
                                    <p class="text-xs text-gray-500 truncate" title="${escapeHtml(post.video_link)}">${escapeHtml(post.video_link)}</p>
                                    <div class="mt-2 flex items-center gap-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                            Open Video
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            `;
        }

        return `
            <div class="post-card" data-post-id="${post.id}">
                <article class="bg-white rounded-xl overflow-hidden card-shadow mb-6">
                    <header class="px-6 py-4 flex items-start gap-4">
                        <img src="{% static 'images/user-profile.png' %}" alt="avatar" class="w-12 h-12 rounded-full object-cover" />
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <h3 class="font-semibold text-lg text-gray-900">${escapeHtml(post.title)}</h3>
                                <span class="text-xs text-gray-500">• ${escapeHtml(post.user)}</span>
                                <span class="text-xs text-gray-400">| ${formatDate(post.created_at)}</span>
                                ${editButtons}
                            </div>
                            
                            <div class="post-content mt-2">
                                <p class="text-gray-700 leading-relaxed">
                                    ${escapeHtml(post.content).replace(/\n/g, '<br>')}
                                </p>
                            </div>
                        </div>
                    </header>

                    ${imageSection}
                    ${videoSection}

                    <footer class="px-6 py-4 border-t border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-6 text-gray-600 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium post-likes-count">${post.likes_count || 0}</span>
                                    <span>likes</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-medium post-dislikes-count">${post.dislikes_count || 0}</span>
                                    <span>dislikes</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="font-medium">${post.comment_count || 0}</span>
                                    <span>comments</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between border-t border-gray-100 pt-3">
                            <div class="flex items-center gap-6">
                                <button class="like-btn flex items-center gap-2 ${post.user_interaction === 'like' ? 'text-pink-600' : 'text-gray-600'} hover:text-pink-600 transition-colors text-sm" data-post-id="${post.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 like-icon ${post.user_interaction === 'like' ? 'fill-pink-600' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                    </svg>
                                    <span class="like-text">${post.user_interaction === 'like' ? 'Liked' : 'Like'}</span>
                                </button>

                                <button class="dislike-btn flex items-center gap-2 ${post.user_interaction === 'dislike' ? 'text-red-600' : 'text-gray-600'} hover:text-red-600 transition-colors text-sm" data-post-id="${post.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 dislike-icon ${post.user_interaction === 'dislike' ? 'fill-red-600' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
                                    </svg>
                                    <span class="dislike-text">${post.user_interaction === 'dislike' ? 'Disliked' : 'Dislike'}</span>
                                </button>

                                <button class="comment-btn flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors text-sm" data-post-id="${post.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 3.866-4.485 7-10 7S1 15.866 1 12 5.485 5 11 5s10 3.134 10 7z" />
                                    </svg>
                                    Comment
                                </button>

                                <button class="save-btn flex items-center gap-2 text-gray-600 hover:text-green-600 transition-colors text-sm" data-post-id="${post.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v16l7-5 7 5V3z" />
                                    </svg>
                                    Save
                                </button>
                            </div>

                            <button class="share-btn flex items-center gap-2 text-gray-600 hover:text-purple-600 transition-colors text-sm" data-post-id="${post.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 6l-4-4-4 4" />
                                </svg>
                                Share
                            </button>
                        </div>

                        <div class="comments-section mt-4 hidden" id="comments-${post.id}">
                            ${post.is_authenticated ? `
                            <div class="mb-4 pb-4 border-b border-gray-100">
                                <form class="add-comment-form" data-post-id="${post.id}">
                                    <div class="flex gap-3 items-start">
                                        <img src="{% static 'images/user-profile.png' %}" alt="Your avatar" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
                                        <div class="flex-1 flex flex-col gap-2">
                                            <textarea placeholder="Write a comment..." class="comment-input flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none" rows="2" required></textarea>
                                            <div class="flex justify-end">
                                                <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 transition-colors flex items-center gap-2">
                                                    <span>Post Comment</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            ` : ''}
                            
                            <div class="space-y-3 comments-list" data-post-id="${post.id}">
                                <div class="loading-comments text-center py-4">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p class="text-gray-500 text-sm">Loading comments...</p>
                                </div>
                            </div>
                        </div>
                    </footer>
                </article>
            </div>
        `;
    }
          function initializeCommentInteractions() {
          // Like comment
          document.querySelectorAll('.comment-like-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const commentId = this.dataset.commentId;
                  const commentItem = this.closest('.comment-item');
                  const likesCount = commentItem.querySelector('.comment-likes-count');
                  const dislikesCount = commentItem.querySelector('.comment-dislikes-count');
                  const likeIcon = this.querySelector('.comment-like-icon');
                  const dislikeBtn = commentItem.querySelector('.comment-dislike-btn');
                  const dislikeIcon = dislikeBtn.querySelector('.comment-dislike-icon');

                  try {
                      const response = await fetch(`/comments/${commentId}/like/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          toggleLikeButtonView(this, data.user_interaction === 'like');
                          toggleDislikeButtonView(dislikeBtn, false);
                          
                          // Update button states
                          if (data.action === 'liked') {
                              this.classList.add('text-pink-600');
                              this.classList.remove('text-gray-600');
                              likeIcon.classList.add('fill-pink-600');
                              // Remove dislike if active
                              dislikeBtn.classList.remove('text-red-600');
                              dislikeBtn.classList.add('text-gray-600');
                              dislikeIcon.classList.remove('fill-red-600');
                          } else {
                              this.classList.remove('text-pink-600');
                              this.classList.add('text-gray-600');
                              likeIcon.classList.remove('fill-pink-600');
                          }
                      }
                  } catch (error) {
                      console.error('Error liking comment:', error);
                  }
              });
          });

          // Dislike comment
          document.querySelectorAll('.comment-dislike-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const commentId = this.dataset.commentId;
                  const commentItem = this.closest('.comment-item');
                  const likesCount = commentItem.querySelector('.comment-likes-count');
                  const dislikesCount = commentItem.querySelector('.comment-dislikes-count');
                  const dislikeIcon = this.querySelector('.comment-dislike-icon');
                  const likeBtn = commentItem.querySelector('.comment-like-btn');
                  const likeIcon = likeBtn.querySelector('.comment-like-icon');

                  try {
                      const response = await fetch(`/comments/${commentId}/dislike/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          toggleLikeButtonView(this, data.user_interaction === 'like');
                          toggleDislikeButtonView(dislikeBtn, false);
                          
                          // Update button states
                          if (data.action === 'disliked') {
                              this.classList.add('text-red-600');
                              this.classList.remove('text-gray-600');
                              dislikeIcon.classList.add('fill-red-600');
                              // Remove like if active
                              likeBtn.classList.remove('text-pink-600');
                              likeBtn.classList.add('text-gray-600');
                              likeIcon.classList.remove('fill-pink-600');
                          } else {
                              this.classList.remove('text-red-600');
                              this.classList.add('text-gray-600');
                              dislikeIcon.classList.remove('fill-red-600');
                          }
                      }
                  } catch (error) {
                      console.error('Error disliking comment:', error);
                  }
              });
          });

          // Delete comment
          document.querySelectorAll('.delete-comment-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  if (!confirm('Are you sure you want to delete this comment?')) return;

                  const commentId = this.dataset.commentId;
                  const commentItem = this.closest('.comment-item');

                  try {
                      const response = await fetch(`/comments/${commentId}/`, {
                          method: 'DELETE',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          commentItem.remove();
                      } else {
                          alert('Error deleting comment: ' + data.message);
                      }
                  } catch (error) {
                      console.error('Error deleting comment:', error);
                      alert('Error deleting comment. Please try again.');
                  }
              });
          });
      }
  function toggleLikeButtonView(likeBtn, isActive) {
      const likeIcon = likeBtn.querySelector('.like-icon');
      const likeText = likeBtn.querySelector('.like-text');
      
      if (isActive) {
          likeBtn.classList.add('text-pink-600');
          likeBtn.classList.remove('text-gray-600');
          likeIcon.classList.add('fill-pink-600');
          likeText.textContent = 'Liked';
      } else {
          likeBtn.classList.remove('text-pink-600');
          likeBtn.classList.add('text-gray-600');
          likeIcon.classList.remove('fill-pink-600');
          likeText.textContent = 'Like';
      }
  }
  function toggleDislikeButtonView(dislikeBtn, isActive) {
      const dislikeIcon = dislikeBtn.querySelector('.dislike-icon');
      const dislikeText = dislikeBtn.querySelector('.dislike-text');
      
      if (isActive) {
          dislikeBtn.classList.add('text-red-600');
          dislikeBtn.classList.remove('text-gray-600');
          dislikeIcon.classList.add('fill-red-600');
          dislikeText.textContent = 'Disliked';
      } else {
          dislikeBtn.classList.remove('text-red-600');
          dislikeBtn.classList.add('text-gray-600');
          dislikeIcon.classList.remove('fill-red-600');
          dislikeText.textContent = 'Dislike';
      }
  }
        function initializePostInteractions() {
          // Like functionality
          document.querySelectorAll('.like-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const postId = this.dataset.postId;
                  const footer = this.closest('footer');
                  const likesCount = footer.querySelector('.post-likes-count');
                  const dislikesCount = footer.querySelector('.post-dislikes-count');
                  const buttonContainer = this.parentElement;
                  const dislikeBtn = buttonContainer.querySelector('.dislike-btn');
                  
                  try {
                      // Call backend API
                      const response = await fetch(`/post/api/posts/${postId}/like/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          // Update counts from server
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          
                          // Update button views based on current state
                          toggleLikeButtonView(this, data.user_interaction === 'like');
                          toggleDislikeButtonView(dislikeBtn, false);
                      }
                  } catch (error) {
                      console.error('Error liking post:', error);
                  }
              });
          });

          // Dislike functionality
          document.querySelectorAll('.dislike-btn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  const postId = this.dataset.postId;
                  const footer = this.closest('footer');
                  const likesCount = footer.querySelector('.post-likes-count');
                  const dislikesCount = footer.querySelector('.post-dislikes-count');
                  const buttonContainer = this.parentElement;
                  const likeBtn = buttonContainer.querySelector('.like-btn');
                  
                  try {
                      // Call backend API
                      const response = await fetch(`/post/api/posts/${postId}/dislike/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                      });

                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          // Update counts from server
                          likesCount.textContent = data.likes_count;
                          dislikesCount.textContent = data.dislikes_count;
                          
                          // Update button views based on current state
                          toggleDislikeButtonView(this, data.user_interaction === 'dislike');
                          toggleLikeButtonView(likeBtn, false);
                      }
                  } catch (error) {
                      console.error('Error disliking post:', error);
                  }
              });
          });

          // Edit button functionality
          document.querySelectorAll('.edit-post-btn').forEach(btn => {
              btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const postId = this.dataset.postId;
                  editPost(postId);
              });
          });


          // Delete button functionality
          document.querySelectorAll('.delete-post-btn').forEach(btn => {
              btn.addEventListener('click', function(e) {
                  e.preventDefault();
                  const postId = this.dataset.postId;
                  deletePost(postId);
              });
          });
          // Comment toggle
          document.querySelectorAll('.comment-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const postId = this.dataset.postId;
                  const commentsSection = document.getElementById(`comments-${postId}`);
                  if (commentsSection) {
                      const wasHidden = commentsSection.classList.contains('hidden');
                      commentsSection.classList.toggle('hidden');
                      
                      // Load comments when opening the section for the first time
                      if (wasHidden && commentsSection.querySelector('.loading-comments')) {
                          loadComments(postId);
                      }
                  }
              });
          });

          // Add comment form submission
          document.querySelectorAll('.add-comment-form').forEach(form => {
              form.addEventListener('submit', async function(e) {
                  e.preventDefault();
                  
                  const postId = this.dataset.postId;
                  const textarea = this.querySelector('.comment-input');
                  const content = textarea.value.trim();
                  
                  if (!content) return;
                  
                  const submitBtn = this.querySelector('button[type="submit"]');
                  const originalText = submitBtn.innerHTML;
                  submitBtn.disabled = true;
                  submitBtn.innerHTML = '<span>Posting...</span>';
                  
                  try {
                      const response = await fetch(`/comments/post/${postId}/`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'X-CSRFToken': csrftoken,
                          },
                          body: JSON.stringify({ content: content })
                      });
                      
                      const data = await response.json();
                      
                      if (data.status === 'success') {
                          textarea.value = '';
                          // Reload comments
                          loadComments(postId);
                      } else {
                          console.error('Server error:', data);
                          alert('Error posting comment: ' + (data.message || 'Unknown error'));
                      }
                  } catch (error) {
                      console.error('Error posting comment:', error);
                      alert('Error posting comment: ' + error.message);
                  } finally {
                      submitBtn.disabled = false;
                      submitBtn.innerHTML = originalText;
                  }
              });
          });

          // Save functionality
          document.querySelectorAll('.save-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  this.classList.toggle('text-green-600');
                  const svg = this.querySelector('svg');
                  if (this.classList.contains('text-green-600')) {
                      svg.classList.add('fill-green-600');
                  } else {
                      svg.classList.remove('fill-green-600');
                  }
              });
          });

          // Share functionality
          document.querySelectorAll('.share-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const postId = this.dataset.postId;
                  
                  // Simple share implementation
                  if (navigator.share) {
                      navigator.share({
                          title: 'Check out this post on Smash!',
                          url: window.location.href + `?post=${postId}`
                      });
                  } else {
                      alert('Post shared! (Copy link to share manually)');
                  }
              });
          });

          // Image modal functionality
          initializeImageModal();
      }
        function initializeImageModal() {
          const modal = document.getElementById('image-modal');
          const modalImage = document.getElementById('modal-image');
          const closeBtn = document.getElementById('close-image-modal');

          if (!modal || !modalImage || !closeBtn) return;

          window.openImageModal = function(imageSrc) {
              modalImage.src = imageSrc;
              modal.classList.remove('hidden');
              document.body.style.overflow = 'hidden';
          };

          closeBtn.addEventListener('click', function() {
              modal.classList.add('hidden');
              document.body.style.overflow = 'auto';
          });

          modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                  modal.classList.add('hidden');
                  document.body.style.overflow = 'auto';
              }
          });
      }
        function showNoPostsMessage(container) {
          if (!container) return;
          container.innerHTML = `
              <div class="text-center py-12">
                  <img src="https://i.pinimg.com/originals/ab/c9/6f/abc96f284c5fd1a927380fe94b07a816.gif" alt="No posts" class="mx-auto w-64 h-64 object-cover rounded-lg">
                  <p class="mt-4 text-gray-500 text-lg">No posts yet</p>
                  <p class="text-gray-400 text-sm">Be the first to create a post!</p>
              </div>
          `;
      }
      async function loadComments(postId) {
          const commentsList = document.querySelector(`.comments-list[data-post-id="${postId}"]`);
          if (!commentsList) return;

          try {
              const response = await fetch(`/comments/post/${postId}/`, {
                  method: 'GET',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': csrftoken,
                  }
              });

              const data = await response.json();
              
              // Remove loading indicator
              const loadingDiv = commentsList.querySelector('.loading-comments');
              if (loadingDiv) loadingDiv.remove();

              if (data.status === 'success' && data.comments && data.comments.length > 0) {
                  commentsList.innerHTML = data.comments.map(comment => createCommentHTML(comment)).join('');
                  initializeCommentInteractions();
              } else {
                  commentsList.innerHTML = `
                      <div class="text-center py-6 text-gray-500 text-sm bg-white rounded-lg">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                          </svg>
                          <p class="font-medium">No comments yet</p>
                          <p class="text-xs text-gray-400 mt-1">Be the first to comment!</p>
                      </div>
                  `;
              }
          } catch (error) {
              console.error('Error loading comments:', error);
              commentsList.innerHTML = `
                  <div class="text-center py-4 text-red-500 text-sm">
                      Error loading comments. Please try again.
                  </div>
              `;
          }
      }
      function createCommentHTML(comment) {
          const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
          const currentUserId = {{ user.id|default:"null" }};
          const canEdit = isAuthenticated && (comment.user_id === currentUserId);
          
          const isLiked = comment.user_interaction === 'like';
          const isDisliked = comment.user_interaction === 'dislike';

          return `
              <div class="comment-item bg-gray-50 rounded-lg p-4" data-comment-id="${comment.id}">
                  <div class="flex gap-3">
                      <img src="{% static 'images/user-profile.png' %}" alt="${escapeHtml(comment.user)}" class="w-8 h-8 rounded-full object-cover flex-shrink-0" />
                      <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                              <span class="font-semibold text-sm text-gray-900">${escapeHtml(comment.user)}</span>
                              <span class="text-xs text-gray-400">${formatDate(comment.created_at)}</span>
                              ${canEdit ? `
                              <button class="delete-comment-btn text-xs text-red-600 hover:text-red-800 ml-auto" data-comment-id="${comment.id}">
                                  Delete
                              </button>
                              ` : ''}
                          </div>
                          <p class="text-sm text-gray-700 mb-2">${escapeHtml(comment.content).replace(/\n/g, '<br>')}</p>
                          ${isAuthenticated ? `
                          <div class="flex items-center gap-4">
                              <button class="comment-like-btn flex items-center gap-1 text-xs ${isLiked ? 'text-pink-600' : 'text-gray-600'} hover:text-pink-600 transition-colors" data-comment-id="${comment.id}">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 comment-like-icon ${isLiked ? 'fill-pink-600' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                  </svg>
                                  <span class="comment-likes-count">${comment.likes_count || 0}</span>
                              </button>
                              <button class="comment-dislike-btn flex items-center gap-1 text-xs ${isDisliked ? 'text-red-600' : 'text-gray-600'} hover:text-red-600 transition-colors" data-comment-id="${comment.id}">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 comment-dislike-icon ${isDisliked ? 'fill-red-600' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018c.163 0 .326.02.485.06L17 4m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
                                  </svg>
                                  <span class="comment-dislikes-count">${comment.dislikes_count || 0}</span>
                              </button>
                          </div>
                          ` : `
                          <div class="flex items-center gap-4 text-xs text-gray-600">
                              <span>${comment.likes_count || 0} likes</span>
                              <span>${comment.dislikes_count || 0} dislikes</span>
                          </div>
                          `}
                      </div>
                  </div>
              </div>
          `;
      }
      function showErrorState(container) {
          if (!container) return;
          const loading = document.getElementById('loading-posts');
          if (loading) loading.remove();
          
          container.innerHTML = `
              <div class="text-center py-12">
                  <img src="https://i.pinimg.com/originals/ab/c9/6f/abc96f284c5fd1a927380fe94b07a816.gif" alt="Error" class="mx-auto w-64 h-64 object-cover rounded-lg">
                  <p class="mt-4 text-gray-500 text-lg">Error loading posts</p>
                  <p class="text-gray-400 text-sm">Please try again later</p>
                  <button onclick="loadPosts()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                      Retry
                  </button>
              </div>
          `;
      }
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g , "&lt;") .replace( />/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
        function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        
        return date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
        });
      }
  async function loadPosts() {
        console.log('Loading posts...');
        try {
          const response = await fetch('/post/api/posts/', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            }
          });
          console.log('Response status:', response.status);
          if (!response.ok) throw new Error('Network response was not ok');

          const data = await response.json();
          allPostData = data.posts || [];
          updateFilterButtonsAppearance();
          if (activeFilter === 'my') allPostData = allPostData.filter(post => post.user_id === CURRENT_USER_ID);
          else if (activeFilter === 'bookmark') allPostData = allPostData.filter(post => post.user_id === CURRENT_USER_ID);
          else if (activeFilter === 'liked') allPostData = allPostData.filter(post => post.user_id === CURRENT_USER_ID);
          if (allPostData.length === 0) displayPageSection({ showEmpty: true });
          console.log('Posts data received:', data);
          const container = document.getElementById('posts-container');
          const loading = document.getElementById('loading-posts');
          if (loading) loading.remove();

          if (data.status === 'success' && Array.isArray(allPostData) && allPostData.length > 0) {
            // Render posts directly without ads
            container.innerHTML = allPostData.map(post => createPostCard(post)).join('');
            initializePostInteractions();
          } else {
            console.log('No posts found');
            showNoPostsMessage(container);
          }
        } catch (error) {
          console.error('Error loading posts:', error);
          showErrorState(document.getElementById('posts-container'));
        }finally {
      displayPageSection({ showLoading: false });
      }
      }

  function handleShowMyPostClick() { activeFilter = 'my'; loadPosts() }
  function handleShowMyBookmarkClick() { activeFilter = 'bookmark'; loadPosts(); }
  function handleShowMyLikeClick() { activeFilter = 'liked'; loadPosts(); }

  function initializePostPage() {
    showMyPostButton?.addEventListener('click', handleShowMyPostClick);
    showMyBookmarkButton?.addEventListener('click', handleShowMyBookmarkClick);
    showMyLikesButton?.addEventListener('click', handleShowMyLikeClick);
    loadPosts();
  }
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    // Load posts when page loads
    loadPosts();

    // Add logout event listeners
    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
    document.getElementById('mobile-logout-btn')?.addEventListener('click', handleLogout);
  });

  // Edit post function
  function editPost(postId) {
      console.log('Editing post:', postId);
      window.location.href = `/post/edit/${postId}/`;
  }
  // Delete post function
  function deletePost(postId) {
      if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
          fetch(`/post/api/posts/${postId}/`, {
              method: 'DELETE',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': csrftoken,
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  alert('Post deleted successfully!');
                  loadPosts(); // Reload posts
              } else {
                  alert('Error deleting post: ' + data.message);
              }
          })
          .catch(error => {
              console.error('Error deleting post:', error);
              alert('Error deleting post. Please try again.');
          });
      }
  }
  initializePostPage();
</script>
<script>
    // Popup Ads logic (randomized)
    (function initPopupAds(){
      try {
        // Throttle: don't show more than once per 10 minutes
        const THROTTLE_MS = 10 * 60 * 1000;
        const lastShown = Number(localStorage.getItem('smash_popup_last_shown') || 0);
        if (Date.now() - lastShown < THROTTLE_MS) return;

        // Build and attach popup DOM
        function renderPopup(ad){
          if (!ad || !ad.image) return;
          const existing = document.getElementById('popup-ads');
          if (existing) existing.remove();

          const overlay = document.createElement('div');
          overlay.id = 'popup-ads';
          overlay.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

          const wrapper = document.createElement('div');
          wrapper.className = 'relative';

          const closeBtn = document.createElement('button');
          closeBtn.id = 'close-ads';
          closeBtn.setAttribute('aria-label','Close');
          closeBtn.className = 'absolute -top-3 -right-3 bg-white rounded-full shadow text-gray-600 w-8 h-8 flex items-center justify-center hover:bg-gray-100';
          closeBtn.innerHTML = '&times;';

          const img = document.createElement('img');
          img.src = ad.image;
          img.alt = ad.title || 'Advertisement';
          img.className = 'w-80 sm:w-96 object-cover shadow-lg rounded-lg';

          if (ad.link) {
            const a = document.createElement('a');
            a.href = `/ads/r/${ad.id}/`;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.appendChild(img);
            wrapper.appendChild(a);
          } else {
            wrapper.appendChild(img);
          }

          wrapper.appendChild(closeBtn);
          overlay.appendChild(wrapper);
          document.body.appendChild(overlay);

          function hide(){ overlay.classList.add('hidden'); localStorage.setItem('smash_popup_last_shown', String(Date.now())); }
          closeBtn.addEventListener('click', hide);
          overlay.addEventListener('click', (e) => { if (e.target === overlay) hide(); });

          const delaySec = Number(ad.popup_delay_seconds || 0);
          const delay = delaySec > 0 ? delaySec * 1000 : (3000 + Math.floor(Math.random() * 4000)); // 3-7s
          setTimeout(() => overlay.classList.remove('hidden'), delay);
        }

        // Fetch ads and pick a random active popup ad
        fetch('/ads/api/')
          .then(r => r.json())
          .then(data => {
            const list = (data && data.ads) ? data.ads : [];
            const candidates = list.filter(ad => ad.is_active && ad.ad_type === 'popup' && ad.image);
            if (!candidates.length) return;
            const randomAd = candidates[Math.floor(Math.random() * candidates.length)];
            renderPopup(randomAd);
          })
          .catch(()=>{});
      } catch(_) {}
    })();
    </script>
{% endblock content %}