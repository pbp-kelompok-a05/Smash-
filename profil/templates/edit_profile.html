{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Edit Profile - Smash</title>
{% endblock meta %}

{% block content %}
<div class="bg-gray-50 w-full min-h-screen">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Back Navigation -->
    <div class="mb-6">
      <a href="{% url 'profil:show_views' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
        <- Back to Profile
      </a>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 form-style">
      <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Edit Profile</h1>
      </div>

      {% if show_messages and messages %}
        <div class="mb-6 space-y-2">
          {% for message in messages %}
            <div class="px-4 py-3 rounded-md text-sm {% if message.tags == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-red-50 text-red-700 border border-red-200{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
      {% if form.non_field_errors %}
        <div class="mb-4 px-4 py-3 rounded-md text-sm bg-red-50 text-red-700 border border-red-200">
          {{ form.non_field_errors|join:", " }}
        </div>
      {% endif %}

      <form method="POST" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        <!-- Field photo -->
         <div class="mt-4 flex items-center gap-4">
            <img src="{% if profile.profile_photo %}{{ profile.profile_photo.url }}{% else %}{% static 'images/user-profile.png' %}{% endif %}"
              alt="Current profile photo" class="w-16 h-16 rounded-full object-cover border">
            <div class="space-y-1">
              <p class="text-sm text-gray-600">Current photo</p>
              <p class="text-sm text-gray-500">
                {% if profile.profile_photo %}
                  Klik ikon tempat sampah untuk menghapus dan kembali ke avatar default.
                {% else %}
                  Sedang menggunakan avatar default.
                {% endif %}
              </p>
            </div>
          </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Profile Photo</label>
          <div class="flex items-center gap-3">
            <input type="file" name="profile_photo" accept="image/*"
              class="w-full text-sm text-gray-600 file:mr-4 file:px-4 file:py-2 file:border file:border-gray-300 file:rounded-md file:bg-white hover:file:bg-gray-50 transition">
            {% if profile.profile_photo %}
            <button type="button" id="remove-photo-btn"
              class="shrink-0 inline-flex items-center justify-center w-10 h-10 rounded-md border border-red-200 text-red-600 hover:bg-red-50 hover:border-red-300 transition"
              title="Hapus foto dan gunakan avatar default">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M8 2a2 2 0 00-2 2v1H4a1 1 0 000 2v9a2 2 0 002 2h8a2 2 0 002-2V7a1 1 0 100-2h-2V4a2 2 0 00-2-2H8zm4 3V4a1 1 0 00-1-1H9a1 1 0 00-1 1v1h4zM8 9a1 1 0 012 0v5a1 1 0 11-2 0V9zm4-1a1 1 0 00-1 1v5a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
            </button>
            {% endif %}
          </div>
          <input type="hidden" name="remove_photo" id="remove-photo-flag" value="">
          {% if form.profile_photo.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.profile_photo.errors|join:", " }}</p>
          {% endif %}
        
        </div>

        <!-- Field username -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input type="text" name="username" value="{{ request.POST.username|default:request.user.username }}"
            class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring focus:border-green-500">
        </div>

        <!-- Field bio -->
        <div>
          <label for="{{ form.bio.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
            Bio
          </label>
          <textarea name="bio" id="{{ form.bio.id_for_label }}" rows="4"
            class="w-full border border-gray-300 rounded-md px-4 py-3 focus:ring focus:border-green-500">{{ form.instance.bio|default_if_none:"" }}</textarea>
          {% if form.bio.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.bio.errors|join:", " }}</p>
          {% endif %}
        </div>

        <!-- Field password -->
        <div>
          <button type="button" id="change-password-trigger"
            class="text-sm font-semibold text-green-700 hover:text-green-800 focus:outline-none underline">
            Change Password?
          </button>
          <p class="text-xs text-gray-500 mt-1">Buka dialog untuk mengganti password dengan aman.</p>
        </div>


        <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
          <a href="{% url 'profil:show_views' %}"
            class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center">
            Cancel
          </a>
          <button type="submit"
            class="order-1 sm:order-2 flex-1 bg-green-600 text-white px-6 py-3 rounded-md font-medium hover:bg-green-700 transition-colors">
            Update Profile
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<div id="password-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
    <h3 class="text-lg font-semibold text-gray-900">Change Password</h3>
    <p class="text-sm text-gray-600 mt-1">Masukkan password lama lalu password baru yang ingin digunakan.</p>
    <div id="password-error" class="hidden mt-3 px-4 py-2 rounded-md border border-red-200 bg-red-50 text-red-700 text-sm"></div>
    <div id="password-success" class="hidden mt-3 px-4 py-2 rounded-md border border-green-200 bg-green-50 text-green-700 text-sm"></div>
    <form id="password-change-form" class="space-y-4 mt-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Old Password</label>
        <input type="password" name="old_password" autocomplete="current-password" required
          class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring focus:border-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
        <input type="password" name="new_password" autocomplete="new-password" required
          class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring focus:border-green-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
        <input type="password" name="confirm_password" autocomplete="new-password" required
          class="w-full border border-gray-300 rounded-md px-4 py-2 focus:ring focus:border-green-500">
      </div>
      <div class="flex flex-col sm:flex-row gap-3 pt-2">
        <button type="button" id="cancel-password-change"
          class="order-2 sm:order-1 w-full sm:w-auto px-6 py-2.5 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors">
          Cancel
        </button>
        <button type="submit" id="submit-password-change"
          class="order-1 sm:order-2 w-full sm:w-auto bg-green-600 text-white px-6 py-2.5 rounded-md font-semibold hover:bg-green-700 transition-colors">
          Update Password
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  (function() {
    const openBtn = document.getElementById('change-password-trigger');
    const modal = document.getElementById('password-modal');
    const form = document.getElementById('password-change-form');
    const cancelBtn = document.getElementById('cancel-password-change');
    const submitBtn = document.getElementById('submit-password-change');
    const errorBox = document.getElementById('password-error');
    const successBox = document.getElementById('password-success');

    const getCsrf = () => {
      const m = document.cookie.match(/csrftoken=([^;]+)/);
      return m ? m[1] : '';
    };

    const toggleModal = (open) => {
      if (!modal) return;
      if (open) {
        modal.classList.remove('hidden');
        return;
      }
      modal.classList.add('hidden');
      if (form) form.reset();
      if (errorBox) {
        errorBox.textContent = '';
        errorBox.classList.add('hidden');
      }
      if (successBox) {
        successBox.textContent = '';
        successBox.classList.add('hidden');
      }
      if (submitBtn) submitBtn.textContent = 'Update Password';
      if (submitBtn) submitBtn.disabled = false;
      if (cancelBtn) cancelBtn.disabled = false;
    };

    const setLoading = (loading) => {
      if (submitBtn) {
        submitBtn.disabled = loading;
        submitBtn.textContent = loading ? 'Updating...' : 'Update Password';
      }
      if (cancelBtn) cancelBtn.disabled = loading;
    };

    if (openBtn) openBtn.addEventListener('click', () => toggleModal(true));
    if (cancelBtn) cancelBtn.addEventListener('click', () => toggleModal(false));

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (errorBox) {
          errorBox.textContent = '';
          errorBox.classList.add('hidden');
        }
        if (successBox) {
          successBox.textContent = '';
          successBox.classList.add('hidden');
        }

        const payload = {
          old_password: form.old_password.value.trim(),
          new_password: form.new_password.value.trim(),
          confirm_password: form.confirm_password.value.trim(),
        };

        if (!payload.old_password || !payload.new_password || !payload.confirm_password) {
          if (errorBox) {
            errorBox.textContent = "Semua kolom wajib diisi.";
            errorBox.classList.remove('hidden');
          }
          return;
        }

        setLoading(true);
        try {
          const res = await fetch("{% url 'profil:change_password_api' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": getCsrf(),
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            },
            credentials: "same-origin",
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          if (!res.ok || !data.status) {
            throw new Error(data.message || "Gagal memperbarui password.");
          }

          if (successBox) {
            successBox.textContent = data.message || "Password berhasil diperbarui.";
            successBox.classList.remove('hidden');
          }
          form.reset();
          setTimeout(() => toggleModal(false), 1200);
        } catch (err) {
          if (errorBox) {
            errorBox.textContent = err.message || "Gagal memperbarui password.";
            errorBox.classList.remove('hidden');
          }
        } finally {
          setLoading(false);
        }
      });
    }
  })();
</script>
{% if profile.profile_photo %}
<div id="delete-modal-overlay" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center relative">
    <div class="w-16 h-16 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M8 2a2 2 0 00-2 2v1H4a1 1 0 000 2v9a2 2 0 002 2h8a2 2 0 002-2V7a1 1 0 100-2h-2V4a2 2 0 00-2-2H8zm4 3V4a1 1 0 00-1-1H9a1 1 0 00-1 1v1h4zM8 9a1 1 0 012 0v5a1 1 0 11-2 0V9zm4-1a1 1 0 00-1 1v5a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" />
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Hapus foto profil?</h3>
    <p class="text-sm text-gray-600 mb-5">Foto akan dihapus dan diganti avatar default.</p>
    <div class="flex flex-col gap-3">
      <button type="button" id="confirm-delete-photo" class="w-full rounded-md bg-red-600 text-white py-2.5 font-semibold hover:bg-red-700 transition">Delete</button>
      <button type="button" id="cancel-delete-photo" class="w-full rounded-md bg-gray-100 text-gray-700 py-2.5 font-semibold hover:bg-gray-200 transition">Cancel</button>
    </div>
  </div>
</div>
{% endif %}
{% if profile.profile_photo %}
<script>
  (function() {
    const removeBtn = document.getElementById('remove-photo-btn');
    const removeFlag = document.getElementById('remove-photo-flag');
    const fileInput = document.querySelector('input[name="profile_photo"]');
    const modal = document.getElementById('delete-modal-overlay');
    const confirmDelete = document.getElementById('confirm-delete-photo');
    const cancelDelete = document.getElementById('cancel-delete-photo');
    if (!removeBtn || !removeFlag) return;

    const getCsrf = () => {
      const m = document.cookie.match(/csrftoken=([^;]+)/);
      return m ? m[1] : '';
    };
    const setLoading = (loading) => {
      if (confirmDelete) confirmDelete.disabled = loading;
      if (cancelDelete) cancelDelete.disabled = loading;
      if (confirmDelete) confirmDelete.textContent = loading ? 'Deleting...' : 'Delete';
    };

    removeBtn.addEventListener('click', () => {
      if (modal) modal.classList.remove('hidden');
      else if (confirm('Hapus foto ini dan kembali ke avatar default?')) {
        removeFlag.value = 'true';
        if (fileInput) fileInput.value = '';
        removeBtn.classList.add('bg-red-50');
        document.forms[0].submit();
      }
    });

    const closeModal = () => modal && modal.classList.add('hidden');

    if (fileInput) {
      fileInput.addEventListener('change', () => {
        removeFlag.value = '';
        removeBtn.classList.remove('bg-red-50');
        closeModal();
      });
    }

    if (cancelDelete) {
      cancelDelete.addEventListener('click', closeModal);
    }

    if (confirmDelete) {
      confirmDelete.addEventListener('click', async () => {
        setLoading(true);
        if (fileInput) fileInput.value = '';
        removeFlag.value = 'true';

        const csrfToken = getCsrf();
        try {
          const res = await fetch("{% url 'profil:profile_api' %}", {
            method: "PATCH",
            headers: {
              "X-CSRFToken": csrfToken,
              "Content-Type": "application/x-www-form-urlencoded"
            },
            credentials: "same-origin",
            body: new URLSearchParams({ remove_photo: "true" })
          });
          if (!res.ok) {
            let msg = "Gagal menghapus foto. Coba lagi.";
            try {
              const data = await res.json();
              if (data && data.message) msg = data.message;
            } catch (_) {}
            throw new Error(msg);
          }
          window.location.reload();
        } catch (e) {
          alert(e.message || "Gagal menghapus foto. Coba lagi.");
          setLoading(false);
        }
      });
    }
  })();
</script>
{% endif %}
{% endblock %}
