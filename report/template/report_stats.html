{% comment %}
<!-- 
Nama File: templates/report/report_stats.html
Deskripsi: Template untuk menampilkan statistik laporan lengkap
Fungsi: Dashboard statistik untuk analisis laporan
Target: Superuser/Admin
-->
{% endcomment %}

{% extends "report/base.html" %}
{% load static %}

{% block report_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar"></i> Statistik Laporan</h2>
    <div>
        <a href="{% url 'report_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-list"></i> Kembali ke Daftar
        </a>
        <button id="export-stats" class="btn btn-success">
            <i class="fas fa-download"></i> Export Data
        </button>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mb-4" id="summary-stats">
    <!-- Summary stats akan di-load via AJAX -->
</div>

<div class="row">
    <!-- Category Statistics -->
    <div class="col-md-6 mb-4">
        <div class="report-card h-100">
            <div class="report-card-header">
                <h5 class="mb-0"><i class="fas fa-tags"></i> Statistik Berdasarkan Kategori</h5>
            </div>
            <div class="report-card-body">
                <div id="category-chart-container">
                    <canvas id="categoryChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Statistics -->
    <div class="col-md-6 mb-4">
        <div class="report-card h-100">
            <div class="report-card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Distribusi Status</h5>
            </div>
            <div class="report-card-body">
                <div id="status-chart-container">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="report-card">
    <div class="report-card-header">
        <h5 class="mb-0"><i class="fas fa-history"></i> Aktivitas Terbaru</h5>
    </div>
    <div class="report-card-body">
        <div id="recent-activity-container">
            <!-- Recent activity akan di-load via AJAX -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    class ReportStats {
        constructor() {
            this.categoryChart = null;
            this.statusChart = null;
            this.init();
        }
        
        init() {
            this.loadStatsData();
            this.bindEvents();
        }
        
        bindEvents() {
            $('#export-stats').on('click', () => {
                this.exportStats();
            });
        }
        
        loadStatsData() {
            $.get('/api/reports/stats/')
                .done((data) => {
                    if (data.status === 'success') {
                        this.renderSummaryStats(data.statistics);
                        this.renderCategoryChart(data.statistics.categories);
                        this.renderStatusChart(data.statistics);
                        this.renderRecentActivity(data.recent_activity);
                    }
                })
                .fail(ReportUtils.handleAjaxError);
        }
        
        renderSummaryStats(stats) {
            $('#summary-stats').html(`
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h3 class="text-primary">${stats.total}</h3>
                            <p class="card-text">Total Laporan</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning">${stats.pending}</h3>
                            <p class="card-text">Menunggu Review</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h3 class="text-info">${stats.reviewed}</h3>
                            <p class="card-text">Sedang Ditinjau</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h3 class="text-success">${stats.resolved}</h3>
                            <p class="card-text">Telah Diselesaikan</p>
                        </div>
                    </div>
                </div>
            `);
        }
        
        renderCategoryChart(categories) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Destroy existing chart
            if (this.categoryChart) {
                this.categoryChart.destroy();
            }
            
            const labels = [];
            const data = [];
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
            ];
            
            Object.values(categories).forEach((category, index) => {
                labels.push(category.name);
                data.push(category.count);
            });
            
            this.categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Laporan',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.2', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Laporan per Kategori'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        renderStatusChart(stats) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Destroy existing chart
            if (this.statusChart) {
                this.statusChart.destroy();
            }
            
            this.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Menunggu', 'Ditinjau', 'Selesai'],
                    datasets: [{
                        data: [stats.pending, stats.reviewed, stats.resolved],
                        backgroundColor: [
                            '#FFCE56', // Pending - Yellow
                            '#36A2EB', // Reviewed - Blue
                            '#4BC0C0'  // Resolved - Teal
                        ],
                        borderColor: [
                            '#FFCE56',
                            '#36A2EB', 
                            '#4BC0C0'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Status Laporan'
                        }
                    }
                }
            });
        }
        
        renderRecentActivity(activities) {
            if (activities.length === 0) {
                $('#recent-activity-container').html(`
                    <div class="text-center py-3">
                        <p class="text-muted">Tidak ada aktivitas terbaru</p>
                    </div>
                `);
                return;
            }
            
            let activityHtml = '<div class="list-group">';
            
            activities.forEach(activity => {
                const statusClass = `status-${activity.status.toLowerCase()}`;
                activityHtml += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                                Laporan #${activity.id} - ${activity.category}
                            </h6>
                            <small>${ReportUtils.formatDate(activity.created_at)}</small>
                        </div>
                        <p class="mb-1">
                            Status: <span class="report-status-badge ${statusClass}">${activity.status}</span>
                        </p>
                    </div>
                `;
            });
            
            activityHtml += '</div>';
            $('#recent-activity-container').html(activityHtml);
        }
        
        exportStats() {
            // Implementasi export data (bisa CSV, PDF, dll.)
            ReportUtils.showNotification('Fitur export akan segera tersedia', 'info');
        }
    }
    
    // Initialize Report Stats when document is ready
    $(document).ready(function() {
        new ReportStats();
    });
</script>
{% endblock %}